˚L
q/home/karolis/Github/Univeras/7-semestras/Program≈≥ Sistem≈≥ Testavimas/PST/Backend/Controllers/AuthController.cs
	namespace		 	
Backend		
 
.		 
Controllers		 
{

 
[ 
ApiController 
] 
[ 
Route 

(
 
$str 
) 
] 
public 

class 
AuthController 
:  !
ControllerBase" 0
{ 
private 
readonly 
AuthHandler $
_authHandler% 1
;1 2
private 
readonly 
UserManager $
<$ %
User% )
>) *
_userManager+ 7
;7 8
private 
readonly 
IMapper  
_mapper! (
;( )
public 
AuthController 
( 
AuthHandler )
authHandler* 5
,5 6
UserManager7 B
<B C
UserC G
>G H
userManagerI T
,T U
IMapperV ]
mapper^ d
)d e
{ 	
_authHandler 
= 
authHandler &
;& '
_userManager 
= 
userManager &
;& '
_mapper 
= 
mapper 
; 
} 	
[ 	
HttpPost	 
( 
$str 
) 
] 
public 
async 
Task 
< 
ActionResult &
<& '
UserGet' .
>. /
>/ 0
Login1 6
(6 7
	UserLogin7 @
dataA E
)E F
{ 	
try 
{ 
var 
user 
= 
await  
_authHandler! -
.- .
Login. 3
(3 4
data4 8
)8 9
;9 :
return   
Ok   
(   
user   
)   
;    
}!! 
catch"" 
("" 
	Exception"" 
ex"" 
)""  
{## 
return$$ 

BadRequest$$ !
($$! "
ex$$" $
.$$$ %
Message$$% ,
)$$, -
;$$- .
}%% 
}&& 	
[(( 	
HttpPost((	 
((( 
$str(( 
)(( 
](( 
public)) 
async)) 
Task)) 
<)) 
ActionResult)) &
<))& '
bool))' +
>))+ ,
>)), -
Logout)). 4
())4 5
)))5 6
{** 	
try++ 
{,, 
var-- 
result-- 
=-- 
await-- "
_authHandler--# /
.--/ 0
Logout--0 6
(--6 7
)--7 8
;--8 9
return.. 
Ok.. 
(.. 
result..  
)..  !
;..! "
}// 
catch00 
(00 
	Exception00 
ex00 
)00  
{11 
return22 

BadRequest22 !
(22! "
ex22" $
.22$ %
Message22% ,
)22, -
;22- .
}33 
}44 	
[66 	
	Authorize66	 
]66 
[77 	
HttpGet77	 
(77 
$str77 
)77 
]77 
public88 
async88 
Task88 
<88 
ActionResult88 &
<88& '
UserGet88' .
>88. /
>88/ 0

GetProfile881 ;
(88; <
)88< =
{99 	
try:: 
{;; 
var<< 
user<< 
=<< 
await<<  
_authHandler<<! -
.<<- .

GetProfile<<. 8
(<<8 9
HttpContext<<9 D
.<<D E
User<<E I
)<<I J
;<<J K
if== 
(== 
user== 
is== 
null==  
)==  !
{>> 
return?? 
NotFound?? #
(??# $
)??$ %
;??% &
}@@ 
returnAA 
OkAA 
(AA 
userAA 
)AA 
;AA  
}BB 
catchCC 
(CC 
	ExceptionCC 
exCC 
)CC  
{DD 
returnEE 

BadRequestEE !
(EE! "
exEE" $
.EE$ %
MessageEE% ,
)EE, -
;EE- .
}FF 
}GG 	
[II 	
HttpPostII	 
(II 
$strII ,
)II, -
]II- .
publicJJ 
asyncJJ 
TaskJJ 
<JJ 
ActionResultJJ &
>JJ& '
RegisterPhysicalJJ( 8
(JJ8 9
RegisterPhysicalJJ9 I
dataJJJ N
)JJN O
{KK 	
tryLL 
{MM 
awaitNN 
_authHandlerNN "
.NN" #
RegisterNN# +
(NN+ ,
dataNN, 0
)NN0 1
;NN1 2
returnOO 
OkOO 
(OO 
)OO 
;OO 
}PP 
catchQQ 
(QQ 
	ExceptionQQ 
exQQ 
)QQ  
{RR 
returnSS 

BadRequestSS !
(SS! "
exSS" $
.SS$ %
MessageSS% ,
)SS, -
;SS- .
}TT 
}UU 	
[WW 	
HttpPostWW	 
(WW 
$strWW )
)WW) *
]WW* +
publicXX 
asyncXX 
TaskXX 
<XX 
ActionResultXX &
>XX& '
RegisterLegalXX( 5
(XX5 6
RegisterLegalXX6 C
dataXXD H
)XXH I
{YY 	
tryZZ 
{[[ 
await\\ 
_authHandler\\ "
.\\" #
Register\\# +
(\\+ ,
data\\, 0
)\\0 1
;\\1 2
return]] 
Ok]] 
(]] 
)]] 
;]] 
}^^ 
catch__ 
(__ 
	Exception__ 
ex__ 
)__  
{`` 
returnaa 

BadRequestaa !
(aa! "
exaa" $
.aa$ %
Messageaa% ,
)aa, -
;aa- .
}bb 
}cc 	
[dd 	
HttpPostdd	 
(dd 
$strdd -
)dd- .
]dd. /
publicee 
asyncee 
Taskee 
<ee 
ActionResultee &
<ee& '
RegistrationRequestee' :
>ee: ;
>ee; <
SubmitRequestee= J
(eeJ K
RegistrationRequesteeK ^
requestee_ f
)eef g
{ff 	
trygg 
{hh 
varii 
requestsii 
=ii 
awaitii $
_authHandlerii% 1
.ii1 2%
SubmitRegistrationRequestii2 K
(iiK L
requestiiL S
)iiS T
;iiT U
returnjj 
Okjj 
(jj 
requestsjj "
)jj" #
;jj# $
}kk 
catchll 
(ll 
	Exceptionll 
exll 
)ll  
{mm 
returnnn 

BadRequestnn !
(nn! "
exnn" $
.nn$ %
Messagenn% ,
)nn, -
;nn- .
}oo 
}pp 	
[rr 	
	Authorizerr	 
(rr 
Rolesrr 
=rr 
$strrr "
)rr" #
]rr# $
[ss 	
HttpPostss	 
(ss 
$strss -
)ss- .
]ss. /
publictt 
asynctt 
Tasktt 
<tt 
ActionResulttt &
>tt& '
ApproveRequesttt( 6
(tt6 7'
RegistrationRequestApprovaltt7 R
requestApprovalttS b
)ttb c
{uu 	
tryvv 
{ww 
varxx 
resultxx 
=xx 
awaitxx "
_authHandlerxx# /
.xx/ 0&
ApproveRegistrationRequestxx0 J
(xxJ K
requestApprovalxxK Z
)xxZ [
;xx[ \
returnyy 
Okyy 
(yy 
resultyy  
)yy  !
;yy! "
}zz 
catch{{ 
({{ 
	Exception{{ 
ex{{ 
){{  
{|| 
return}} 

BadRequest}} !
(}}! "
ex}}" $
.}}$ %
Message}}% ,
)}}, -
;}}- .
}~~ 
} 	
[
ÅÅ 	
	Authorize
ÅÅ	 
(
ÅÅ 
Roles
ÅÅ 
=
ÅÅ 
$str
ÅÅ "
)
ÅÅ" #
]
ÅÅ# $
[
ÇÇ 	
HttpGet
ÇÇ	 
(
ÇÇ 
$str
ÇÇ +
)
ÇÇ+ ,
]
ÇÇ, -
public
ÉÉ 
async
ÉÉ 
Task
ÉÉ 
<
ÉÉ 
ActionResult
ÉÉ &
<
ÉÉ& '
List
ÉÉ' +
<
ÉÉ+ ,!
RegistrationRequest
ÉÉ, ?
>
ÉÉ? @
>
ÉÉ@ A
>
ÉÉA B,
GetCompanyRegistrationRequests
ÉÉC a
(
ÉÉa b
)
ÉÉb c
{
ÑÑ 	
try
ÖÖ 
{
ÜÜ 
var
áá 
requests
áá 
=
áá 
await
áá $
_authHandler
áá% 1
.
áá1 2%
GetRegistrationRequests
áá2 I
(
ááI J
)
ááJ K
;
ááK L
return
àà 
Ok
àà 
(
àà 
requests
àà "
)
àà" #
;
àà# $
}
ââ 
catch
ää 
(
ää 
	Exception
ää 
ex
ää 
)
ää  
{
ãã 
return
åå 

BadRequest
åå !
(
åå! "
ex
åå" $
.
åå$ %
Message
åå% ,
)
åå, -
;
åå- .
}
çç 
}
éé 	
}
èè 
}êê ≥I
w/home/karolis/Github/Univeras/7-semestras/Program≈≥ Sistem≈≥ Testavimas/PST/Backend/Controllers/BorrowingsController.cs
	namespace 	
Backend
 
. 
Controllers 
{ 
[ 
ApiController 
] 
[		 
Route		 

(		
 
$str		 
)		 
]		 
public

 

class

  
BorrowingsController

 %
:

& '
ControllerBase

( 6
{ 
private 
readonly 
BorrowingsHandler *
_handler+ 3
;3 4
public  
BorrowingsController #
(# $
BorrowingsHandler$ 5
handler6 =
)= >
{ 	
_handler 
= 
handler 
; 
} 	
[ 	
	Authorize	 
( 
Roles 
= 
$str "
)" #
]# $
[ 	
HttpGet	 
( 
$str 
) 
] 
public 
async 
Task 
< 
ActionResult &
<& '
List' +
<+ ,
BorrowingGetDto, ;
>; <
>< =
>= >
GetAll? E
(E F
)F G
{ 	
try 
{ 
var 
result 
= 
await "
_handler# +
.+ ,
GetAllAsync, 7
(7 8
)8 9
;9 :
return 
Ok 
( 
result  
)  !
;! "
} 
catch 
( 
	Exception 
ex 
)  
{ 
return 

BadRequest !
(! "
ex" $
.$ %
Message% ,
), -
;- .
} 
} 	
[   	
	Authorize  	 
(   
Roles   
=   
$str   %
)  % &
]  & '
[!! 	
HttpGet!!	 
(!! 
$str!! 
)!! 
]!! 
public"" 
async"" 
Task"" 
<"" 
ActionResult"" &
<""& '
List""' +
<""+ ,
BorrowingGetDto"", ;
>""; <
>""< =
>""= >
	GetByUser""? H
(""H I
)""I J
{## 	
try$$ 
{%% 
var&& 
result&& 
=&& 
await&& "
_handler&&# +
.&&+ ,
GetByUserAsync&&, :
(&&: ;
User&&; ?
)&&? @
;&&@ A
return'' 
Ok'' 
('' 
result''  
)''  !
;''! "
}(( 
catch)) 
()) 
	Exception)) 
ex)) 
)))  
{** 
return++ 

BadRequest++ !
(++! "
ex++" $
.++$ %
Message++% ,
)++, -
;++- .
},, 
}-- 	
[.. 	
	Authorize..	 
(.. 
Roles.. 
=.. 
$str.. ,
).., -
]..- .
[// 	
HttpGet//	 
(// 
$str// 
)// 
]// 
public00 
async00 
Task00 
<00 
ActionResult00 &
<00& '
BorrowingGetDto00' 6
>006 7
>007 8
GetById009 @
(00@ A
int00A D
id00E G
)00G H
{11 	
try22 
{33 
var44 
result44 
=44 
await44 "
_handler44# +
.44+ ,
GetByIdAsync44, 8
(448 9
id449 ;
)44; <
;44< =
return55 
Ok55 
(55 
result55  
)55  !
;55! "
}66 
catch77 
(77 
	Exception77 
ex77 
)77  
{88 
return99 

BadRequest99 !
(99! "
ex99" $
.99$ %
Message99% ,
)99, -
;99- .
}:: 
};; 	
[<< 	
	Authorize<<	 
(<< 
Roles<< 
=<< 
$str<< %
)<<% &
]<<& '
[== 	
HttpPost==	 
(== 
$str== 
)== 
]== 
public>> 
async>> 
Task>> 
<>> 
ActionResult>> &
>>>& '
Add>>( +
(>>+ ,
BorrowingAddDto>>, ;
addDto>>< B
)>>B C
{?? 	
try@@ 
{AA 
awaitBB 
_handlerBB 
.BB 
AddAsyncBB '
(BB' (
addDtoBB( .
,BB. /
UserBB0 4
)BB4 5
;BB5 6
returnCC 
OkCC 
(CC 
)CC 
;CC 
}DD 
catchEE 
(EE 
	ExceptionEE 
exEE 
)EE  
{FF 
returnGG 

BadRequestGG !
(GG! "
exGG" $
.GG$ %
MessageGG% ,
)GG, -
;GG- .
}HH 
}II 	
[JJ 	
	AuthorizeJJ	 
(JJ 
RolesJJ 
=JJ 
$strJJ "
)JJ" #
]JJ# $
[KK 	
	HttpPatchKK	 
(KK 
$strKK 
)KK 
]KK 
publicLL 
asyncLL 
TaskLL 
<LL 
ActionResultLL &
>LL& '
UpdateLL( .
(LL. /
BorrowingUpdateDtoLL/ A
	updateDtoLLB K
)LLK L
{MM 	
tryNN 
{OO 
awaitPP 
_handlerPP 
.PP 
UpdateAsyncPP *
(PP* +
	updateDtoPP+ 4
,PP4 5
UserPP6 :
)PP: ;
;PP; <
returnQQ 
OkQQ 
(QQ 
)QQ 
;QQ 
}RR 
catchSS 
(SS 
	ExceptionSS 
exSS 
)SS  
{TT 
returnUU 

BadRequestUU !
(UU! "
exUU" $
.UU$ %
MessageUU% ,
)UU, -
;UU- .
}VV 
}WW 	
[XX 	
	AuthorizeXX	 
(XX 
RolesXX 
=XX 
$strXX ,
)XX, -
]XX- .
[YY 	
	HttpPatchYY	 
(YY 
$strYY 
)YY 
]YY 
publicZZ 
asyncZZ 
TaskZZ 
<ZZ 
ActionResultZZ &
>ZZ& '
UpdateStatusZZ( 4
(ZZ4 5$
BorrowingUpdateStatusDtoZZ5 M
	statusDtoZZN W
)ZZW X
{[[ 	
try\\ 
{]] 
await^^ 
_handler^^ 
.^^ 
UpdateStatusAsync^^ 0
(^^0 1
	statusDto^^1 :
)^^: ;
;^^; <
return__ 
Ok__ 
(__ 
)__ 
;__ 
}`` 
catchaa 
(aa 
	Exceptionaa 
exaa 
)aa  
{bb 
returncc 

BadRequestcc !
(cc! "
excc" $
.cc$ %
Messagecc% ,
)cc, -
;cc- .
}dd 
}ee 	
[ff 	
	Authorizeff	 
(ff 
Rolesff 
=ff 
$strff "
)ff" #
]ff# $
[gg 	

HttpDeletegg	 
(gg 
$strgg 
)gg 
]gg 
publichh 
asynchh 
Taskhh 
<hh 
ActionResulthh &
>hh& '
Deletehh( .
(hh. /
inthh/ 2
idhh3 5
)hh5 6
{ii 	
tryjj 
{kk 
awaitll 
_handlerll 
.ll 
DeleteAsyncll *
(ll* +
idll+ -
)ll- .
;ll. /
returnmm 
Okmm 
(mm 
)mm 
;mm 
}nn 
catchoo 
(oo 
	Exceptionoo 
exoo 
)oo  
{pp 
returnqq 

BadRequestqq !
(qq! "
exqq" $
.qq$ %
Messageqq% ,
)qq, -
;qq- .
}rr 
}ss 	
[tt 	
	Authorizett	 
(tt 
Rolestt 
=tt 
$strtt "
)tt" #
]tt# $
[uu 	
HttpGetuu	 
(uu 
$struu !
)uu! "
]uu" #
publicvv 
asyncvv 
Taskvv 
<vv 
ActionResultvv &
<vv& '
boolvv' +
>vv+ ,
>vv, -
	CanDeletevv. 7
(vv7 8
intvv8 ;
idvv< >
)vv> ?
{ww 	
tryxx 
{yy 
returnzz 
Okzz 
(zz 
_handlerzz "
.zz" #
	CanDeletezz# ,
(zz, -
idzz- /
)zz/ 0
)zz0 1
;zz1 2
}|| 
catch}} 
(}} 
	Exception}} 
ex}} 
)}}  
{~~ 
return 

BadRequest !
(! "
ex" $
.$ %
Message% ,
), -
;- .
}
ÄÄ 
}
ÅÅ 	
}
ÇÇ 
}ÉÉ ¯=
r/home/karolis/Github/Univeras/7-semestras/Program≈≥ Sistem≈≥ Testavimas/PST/Backend/Controllers/ChatsController.cs
	namespace 	
Backend
 
. 
Controllers 
{		 
[

 
ApiController

 
]

 
[ 
Route 

(
 
$str 
) 
] 
public 

class 
ChatsController  
:! "
ControllerBase# 1
{ 
private 
readonly 
ChatsHandler %
_handler& .
;. /
public 
ChatsController 
( 
ChatsHandler +
handler, 3
)3 4
{ 	
_handler 
= 
handler 
; 
} 	
[ 	
	Authorize	 
( 
Roles 
= 
$str "
)" #
]# $
[ 	
HttpGet	 
( 
$str 
)  
]  !
public 
async 
Task 
< 
ActionResult &
<& '
List' +
<+ ,
ConversationGetDto, >
>> ?
>? @
>@ A
GetAllConversationsB U
(U V
)V W
{ 	
try 
{ 
return 
await 
_handler %
.% &
GetAllConversations& 9
(9 :
): ;
;; <
} 
catch 
( 
	Exception 
ex 
)  
{ 
return 

BadRequest !
(! "
ex" $
.$ %
Message% ,
), -
;- .
}   
}!! 	
["" 	
	Authorize""	 
("" 
Roles"" 
="" 
$str"" #
)""# $
]""$ %
[## 	
HttpGet##	 
(## 
$str##  
)##  !
]##! "
public$$ 
async$$ 
Task$$ 
<$$ 
ActionResult$$ &
<$$& '
List$$' +
<$$+ ,
ConversationGetDto$$, >
>$$> ?
>$$? @
>$$@ A"
GetLenderConversations$$B X
($$X Y
)$$Y Z
{%% 	
try&& 
{'' 
return(( 
await(( 
_handler(( %
.((% &"
GetLenderConversations((& <
(((< =
User((= A
)((A B
;((B C
})) 
catch** 
(** 
	Exception** 
ex** 
)**  
{++ 
return,, 

BadRequest,, !
(,,! "
ex,," $
.,,$ %
Message,,% ,
),,, -
;,,- .
}-- 
}.. 	
[// 	
	Authorize//	 
(// 
Roles// 
=// 
$str// %
)//% &
]//& '
[00 	
HttpGet00	 
(00 
$str00 "
)00" #
]00# $
public11 
async11 
Task11 
<11 
ActionResult11 &
<11& '
List11' +
<11+ ,
ConversationGetDto11, >
>11> ?
>11? @
>11@ A$
GetBorrowerConversations11B Z
(11Z [
)11[ \
{22 	
try33 
{44 
return55 
await55 
_handler55 %
.55% &$
GetBorrowerConversations55& >
(55> ?
User55? C
)55C D
;55D E
}66 
catch77 
(77 
	Exception77 
ex77 
)77  
{88 
return99 

BadRequest99 !
(99! "
ex99" $
.99$ %
Message99% ,
)99, -
;99- .
}:: 
};; 	
[<< 	
	Authorize<<	 
]<< 
[== 	
HttpGet==	 
(== 
$str== &
)==& '
]==' (
public>> 
async>> 
Task>> 
<>> 
ActionResult>> &
<>>& '
ConversationGetDto>>' 9
>>>9 :
>>>: ;
GetConversation>>< K
(>>K L
int>>L O
userConsoleId>>P ]
)>>] ^
{?? 	
try@@ 
{AA 
returnBB 
awaitBB 
_handlerBB %
.BB% &
GetConversationBB& 5
(BB5 6
userConsoleIdBB6 C
)BBC D
;BBD E
}CC 
catchDD 
(DD 
	ExceptionDD 
exDD 
)DD  
{EE 
returnFF 

BadRequestFF !
(FF! "
exFF" $
.FF$ %
MessageFF% ,
)FF, -
;FF- .
}GG 
}HH 	
[II 	
	AuthorizeII	 
(II 
RolesII 
=II 
$strII "
)II" #
]II# $
[JJ 	
HttpPostJJ	 
(JJ 
$strJJ 2
)JJ2 3
]JJ3 4
publicKK 
asyncKK 
TaskKK 
<KK 
ActionResultKK &
>KK& '
ContactLenderKK( 5
(KK5 6
intKK6 9
userConsoleIdKK: G
)KKG H
{LL 	
tryMM 
{NN 
awaitOO 
_handlerOO 
.OO 
ContactLenderOO ,
(OO, -
userConsoleIdOO- :
)OO: ;
;OO; <
returnPP 
OkPP 
(PP 
)PP 
;PP 
}QQ 
catchRR 
(RR 
	ExceptionRR 
exRR 
)RR  
{SS 
returnTT 

BadRequestTT !
(TT! "
exTT" $
.TT$ %
MessageTT% ,
)TT, -
;TT- .
}UU 
}VV 	
[WW 	
	AuthorizeWW	 
(WW 
RolesWW 
=WW 
$strWW "
)WW" #
]WW# $
[XX 	
HttpPostXX	 
(XX 
$strXX 2
)XX2 3
]XX3 4
publicYY 
asyncYY 
TaskYY 
<YY 
ActionResultYY &
>YY& '
ContactBorrowerYY( 7
(YY7 8
intYY8 ;
borrowingIdYY< G
)YYG H
{ZZ 	
try[[ 
{\\ 
await]] 
_handler]] 
.]] 
ContactBorrower]] .
(]]. /
borrowingId]]/ :
)]]: ;
;]]; <
return^^ 
Ok^^ 
(^^ 
)^^ 
;^^ 
}__ 
catch`` 
(`` 
	Exception`` 
ex`` 
)``  
{aa 
returnbb 

BadRequestbb !
(bb! "
exbb" $
.bb$ %
Messagebb% ,
)bb, -
;bb- .
}cc 
}dd 	
[ee 	
	Authorizeee	 
]ee 
[ff 	
HttpPostff	 
(ff 
$strff 
)ff 
]ff 
publicgg 
asyncgg 
Taskgg 
<gg 
ActionResultgg &
>gg& '
SendMessagegg( 3
(gg3 4
MessageAddDtogg4 A
addDtoggB H
)ggH I
{hh 	
tryii 
{jj 
awaitkk 
_handlerkk 
.kk 
SendMessagekk *
(kk* +
addDtokk+ 1
,kk1 2
Userkk3 7
)kk7 8
;kk8 9
returnll 
Okll 
(ll 
)ll 
;ll 
}mm 
catchnn 
(nn 
	Exceptionnn 
exnn 
)nn  
{oo 
returnpp 

BadRequestpp !
(pp! "
expp" $
.pp$ %
InnerExceptionpp% 3
.pp3 4
Messagepp4 ;
)pp; <
;pp< =
}qq 
}rr 	
}ss 
}tt ÏJ
u/home/karolis/Github/Univeras/7-semestras/Program≈≥ Sistem≈≥ Testavimas/PST/Backend/Controllers/ConsolesController.cs
	namespace		 	
Backend		
 
.		 
Controllers		 
{

 
[ 
ApiController 
] 
[ 
Route 

(
 
$str 
) 
] 
public 

class 
ConsolesController #
:$ %
ControllerBase& 4
{ 
private 
readonly 
ConsolesHandler (
_consolesHandler) 9
;9 :
private 
readonly 
FilesHandler %
_imagesHandler& 4
;4 5
public 
ConsolesController !
(! "
ConsolesHandler" 1
consolesHandler2 A
,A B
FilesHandlerC O
imagesHandlerP ]
)] ^
{ 	
_consolesHandler 
= 
consolesHandler .
;. /
_imagesHandler 
= 
imagesHandler *
;* +
} 	
[ 	
HttpGet	 
( 
$str 
) 
] 
public 
async 
Task 
< 
ActionResult &
>& '
GetConsoles( 3
(3 4
)4 5
{ 	
try 
{ 
var 
result 
= 
await "
_consolesHandler# 3
.3 4
GetConsolesAsync4 D
(D E
)E F
;F G
return 
Ok 
( 
result  
)  !
;! "
}!! 
catch"" 
("" 
	Exception"" 
ex"" 
)""  
{## 
return$$ 

BadRequest$$ !
($$! "
ex$$" $
.$$$ %
Message$$% ,
)$$, -
;$$- .
}%% 
}'' 	
[(( 	
HttpGet((	 
((( 
$str(( 
)(( 
](( 
public)) 
async)) 
Task)) 
<)) 
ActionResult)) &
<))& '
ImageUploadResult))' 8
>))8 9
>))9 :

GetConsole)); E
())E F
int))F I
id))J L
)))L M
{** 	
try++ 
{,, 
var-- 
result-- 
=-- 
await-- "
_consolesHandler--# 3
.--3 4
GetConsoleAsync--4 C
(--C D
id--D F
)--F G
;--G H
return// 
Ok// 
(// 
result//  
)//  !
;//! "
}11 
catch22 
(22 
	Exception22 
ex22 
)22  
{33 
return44 

BadRequest44 !
(44! "
ex44" $
.44$ %
Message44% ,
)44, -
;44- .
}55 
}66 	
[77 	
	Authorize77	 
(77 
Roles77 
=77 
$str77 "
)77" #
]77# $
[88 	
HttpPost88	 
(88 
$str88 
)88 
]88 
public99 
async99 
Task99 
<99 
ActionResult99 &
>99& '

AddConsole99( 2
(992 3
ConsoleAddDto993 @

consoleDto99A K
)99K L
{:: 	
try;; 
{<< 
var>> 
result>> 
=>> 
await>> "
_consolesHandler>># 3
.>>3 4
AddConsoleAsync>>4 C
(>>C D

consoleDto>>D N
)>>N O
;>>O P
return@@ 
Ok@@ 
(@@ 
result@@  
)@@  !
;@@! "
}BB 
catchCC 
(CC 
	ExceptionCC 
exCC 
)CC  
{DD 
returnEE 

BadRequestEE !
(EE! "
exEE" $
.EE$ %
InnerExceptionEE% 3
.EE3 4
MessageEE4 ;
)EE; <
;EE< =
}FF 
}GG 	
[HH 	
	AuthorizeHH	 
(HH 
RolesHH 
=HH 
$strHH "
)HH" #
]HH# $
[II 	
HttpPutII	 
(II 
$strII 
)II 
]II 
publicJJ 
asyncJJ 
TaskJJ 
<JJ 
ActionResultJJ &
>JJ& '
UpdateConsoleJJ( 5
(JJ5 6
ConsoleUpdateDtoJJ6 F

consoleDtoJJG Q
)JJQ R
{KK 	
tryLL 
{MM 
varNN 
resultNN 
=NN 
awaitNN "
_consolesHandlerNN# 3
.NN3 4
UpdateConsoleAsyncNN4 F
(NNF G

consoleDtoNNG Q
)NNQ R
;NNR S
returnPP 
OkPP 
(PP 
resultPP  
)PP  !
;PP! "
}RR 
catchSS 
(SS 
	ExceptionSS 
exSS 
)SS  
{TT 
returnUU 

BadRequestUU !
(UU! "
exUU" $
.UU$ %
MessageUU% ,
)UU, -
;UU- .
}VV 
}WW 	
[XX 	
	AuthorizeXX	 
(XX 
RolesXX 
=XX 
$strXX "
)XX" #
]XX# $
[YY 	
HttpGetYY	 
(YY 
$strYY !
)YY! "
]YY" #
publicZZ 
asyncZZ 
TaskZZ 
<ZZ 
ActionResultZZ &
<ZZ& '
boolZZ' +
>ZZ+ ,
>ZZ, -
	CanDeleteZZ. 7
(ZZ7 8
intZZ8 ;
idZZ< >
)ZZ> ?
{[[ 	
try\\ 
{]] 
return^^ 
Ok^^ 
(^^ 
_consolesHandler^^ *
.^^* +
	CanDelete^^+ 4
(^^4 5
id^^5 7
)^^7 8
)^^8 9
;^^9 :
}`` 
catchaa 
(aa 
	Exceptionaa 
exaa 
)aa  
{bb 
returncc 

BadRequestcc !
(cc! "
excc" $
.cc$ %
Messagecc% ,
)cc, -
;cc- .
}dd 
}ee 	
[ff 	
	Authorizeff	 
(ff 
Rolesff 
=ff 
$strff "
)ff" #
]ff# $
[gg 	

HttpDeletegg	 
(gg 
$strgg !
)gg! "
]gg" #
publichh 
asynchh 
Taskhh 
<hh 
ActionResulthh &
<hh& '
ImageUploadResulthh' 8
>hh8 9
>hh9 :
RemoveConsolehh; H
(hhH I
inthhI L
idhhM O
)hhO P
{ii 	
tryjj 
{kk 
awaitll 
_consolesHandlerll &
.ll& '
RemoveConsoleAsyncll' 9
(ll9 :
idll: <
)ll< =
;ll= >
returnmm 
Okmm 
(mm 
)mm 
;mm 
}oo 
catchpp 
(pp 
	Exceptionpp 
expp 
)pp  
{qq 
returnrr 

BadRequestrr !
(rr! "
exrr" $
.rr$ %
Messagerr% ,
)rr, -
;rr- .
}ss 
}tt 	
[uu 	
	Authorizeuu	 
(uu 
Rolesuu 
=uu 
$struu "
)uu" #
]uu# $
[vv 	
HttpPostvv	 
(vv 
$strvv 
)vv 
]vv  
publicww 
asyncww 
Taskww 
<ww 
ActionResultww &
>ww& '
AddImageww( 0
(ww0 1
ImageAddDtoww1 <
imageDtoww= E
)wwE F
{xx 	
tryyy 
{zz 
await{{ 
_imagesHandler{{ $
.{{$ %
AddImageAsync{{% 2
({{2 3
imageDto{{3 ;
){{; <
;{{< =
return|| 
Ok|| 
(|| 
)|| 
;|| 
}~~ 
catch 
( 
	Exception 
ex 
)  
{
ÄÄ 
return
ÅÅ 

BadRequest
ÅÅ !
(
ÅÅ! "
ex
ÅÅ" $
.
ÅÅ$ %
Message
ÅÅ% ,
)
ÅÅ, -
;
ÅÅ- .
}
ÇÇ 
}
ÉÉ 	
[
ÑÑ 	
	Authorize
ÑÑ	 
(
ÑÑ 
Roles
ÑÑ 
=
ÑÑ 
$str
ÑÑ "
)
ÑÑ" #
]
ÑÑ# $
[
ÖÖ 	

HttpDelete
ÖÖ	 
(
ÖÖ 
$str
ÖÖ (
)
ÖÖ( )
]
ÖÖ) *
public
ÜÜ 
async
ÜÜ 
Task
ÜÜ 
<
ÜÜ 
ActionResult
ÜÜ &
>
ÜÜ& '
RemoveImage
ÜÜ( 3
(
ÜÜ3 4
int
ÜÜ4 7
id
ÜÜ8 :
)
ÜÜ: ;
{
áá 	
try
àà 
{
ââ 
await
ää 
_imagesHandler
ää $
.
ää$ %
RemoveImageAsync
ää% 5
(
ää5 6
id
ää6 8
)
ää8 9
;
ää9 :
return
ãã 
Ok
ãã 
(
ãã 
)
ãã 
;
ãã 
}
çç 
catch
éé 
(
éé 
	Exception
éé 
ex
éé 
)
éé  
{
èè 
return
êê 

BadRequest
êê !
(
êê! "
ex
êê" $
.
êê$ %
Message
êê% ,
)
êê, -
;
êê- .
}
ëë 
}
íí 	
}
ìì 
}îî µm
y/home/karolis/Github/Univeras/7-semestras/Program≈≥ Sistem≈≥ Testavimas/PST/Backend/Controllers/UserConsolesController.cs
	namespace		 	
Backend		
 
.		 
Controllers		 
{

 
[ 
ApiController 
] 
[ 
Route 

(
 
$str 
) 
] 
[ 
	Authorize 
] 
public 

class "
UserConsolesController '
:( )
ControllerBase* 8
{ 
private 
readonly 
UserConsolesHandler , 
_userConsolesHandler- A
;A B
private 
readonly 
FilesHandler %
_imagesHandler& 4
;4 5
public "
UserConsolesController %
(% &
UserConsolesHandler& 9
handler: A
)A B
{ 	 
_userConsolesHandler  
=! "
handler# *
;* +
} 	
[ 	
HttpGet	 
( 
$str 
) 
] 
public 
async 
Task 
< 
ActionResult &
>& '
GetUserConsoles( 7
(7 8
)8 9
{ 	
try 
{ 
var 
result 
= 
await " 
_userConsolesHandler# 7
.7 8 
GetUserConsolesAsync8 L
(L M
UserM Q
)Q R
;R S
return 
Ok 
( 
result  
)  !
;! "
}!! 
catch"" 
("" 
	Exception"" 
ex"" 
)""  
{## 
return$$ 

BadRequest$$ !
($$! "
ex$$" $
.$$$ %
Message$$% ,
)$$, -
;$$- .
}%% 
}&& 	
[(( 	
HttpPost((	 
((( 
$str(( 
)(( 
]((  
public)) 
async)) 
Task)) 
<)) 
ActionResult)) &
>))& '#
GetUserConsolesByStatus))( ?
())? @%
UserConsolesStatusRequest))@ Y
status))Z `
)))` a
{** 	
try++ 
{,, 
var-- 
result-- 
=-- 
await-- " 
_userConsolesHandler--# 7
.--7 8(
GetUserConsolesByStatusAsync--8 T
(--T U
User--U Y
,--Y Z
status--[ a
.--a b
ConsoleStatus--b o
)--o p
;--p q
return// 
Ok// 
(// 
result//  
)//  !
;//! "
}11 
catch22 
(22 
	Exception22 
ex22 
)22  
{33 
return44 

BadRequest44 !
(44! "
ex44" $
.44$ %
Message44% ,
)44, -
;44- .
}55 
}66 	
[88 	
HttpGet88	 
(88 
$str88 
)88 
]88 
public99 
async99 
Task99 
<99 
ActionResult99 &
<99& '
ImageUploadResult99' 8
>998 9
>999 :
GetUserConsole99; I
(99I J
int99J M
id99N P
)99P Q
{:: 	
try;; 
{<< 
var== 
result== 
=== 
await== " 
_userConsolesHandler==# 7
.==7 8
GetUserConsoleAsync==8 K
(==K L
id==L N
)==N O
;==O P
return?? 
Ok?? 
(?? 
result??  
)??  !
;??! "
}AA 
catchBB 
(BB 
	ExceptionBB 
exBB 
)BB  
{CC 
returnDD 

BadRequestDD !
(DD! "
exDD" $
.DD$ %
MessageDD% ,
)DD, -
;DD- .
}EE 
}FF 	
[GG 	
	AuthorizeGG	 
(GG 
RolesGG 
=GG 
$strGG #
)GG# $
]GG$ %
[HH 	
HttpPostHH	 
(HH 
$strHH 
)HH 
]HH 
publicII 
asyncII 
TaskII 
<II 
ActionResultII &
>II& '
AddUserConsoleII( 6
(II6 7
UserConsoleAddDtoII7 H

consoleDtoIII S
)IIS T
{JJ 	
tryKK 
{LL 
varNN 
resultNN 
=NN 
awaitNN " 
_userConsolesHandlerNN# 7
.NN7 8
AddUserConsoleAsyncNN8 K
(NNK L

consoleDtoNNL V
,NNV W
UserNNX \
)NN\ ]
;NN] ^
returnPP 
OkPP 
(PP 
resultPP  
)PP  !
;PP! "
}RR 
catchSS 
(SS 
	ExceptionSS 
exSS 
)SS  
{TT 
returnUU 

BadRequestUU !
(UU! "
exUU" $
.UU$ %
InnerExceptionUU% 3
.UU3 4
MessageUU4 ;
)UU; <
;UU< =
}VV 
}WW 	
[XX 	
	AuthorizeXX	 
(XX 
RolesXX 
=XX 
$strXX #
)XX# $
]XX$ %
[YY 	
HttpPutYY	 
(YY 
$strYY 
)YY 
]YY 
publicZZ 
asyncZZ 
TaskZZ 
<ZZ 
ActionResultZZ &
>ZZ& '
UpdateUserConsoleZZ( 9
(ZZ9 : 
UserConsoleUpdateDtoZZ: N

consoleDtoZZO Y
)ZZY Z
{[[ 	
try\\ 
{]] 
var^^ 
result^^ 
=^^ 
await^^ " 
_userConsolesHandler^^# 7
.^^7 8"
UpdateUserConsoleAsync^^8 N
(^^N O

consoleDto^^O Y
)^^Y Z
;^^Z [
return`` 
Ok`` 
(`` 
result``  
)``  !
;``! "
}bb 
catchcc 
(cc 
	Exceptioncc 
excc 
)cc  
{dd 
returnee 

BadRequestee !
(ee! "
exee" $
.ee$ %
Messageee% ,
)ee, -
;ee- .
}ff 
}gg 	
[hh 	
	Authorizehh	 
(hh 
Roleshh 
=hh 
$strhh "
)hh" #
]hh# $
[ii 	

HttpDeleteii	 
(ii 
$strii !
)ii! "
]ii" #
publicjj 
asyncjj 
Taskjj 
<jj 
ActionResultjj &
<jj& '
ImageUploadResultjj' 8
>jj8 9
>jj9 :
RemoveUserConsolejj; L
(jjL M
intjjM P
idjjQ S
)jjS T
{kk 	
tryll 
{mm 
awaitnn  
_userConsolesHandlernn *
.nn* +"
RemoveUserConsoleAsyncnn+ A
(nnA B
idnnB D
)nnD E
;nnE F
returnoo 
Okoo 
(oo 
)oo 
;oo 
}qq 
catchrr 
(rr 
	Exceptionrr 
exrr 
)rr  
{ss 
returntt 

BadRequesttt !
(tt! "
extt" $
.tt$ %
Messagett% ,
)tt, -
;tt- .
}uu 
}vv 	
[ww 	
	Authorizeww	 
(ww 
Rolesww 
=ww 
$strww #
)ww# $
]ww$ %
[xx 	
HttpPostxx	 
(xx 
$strxx 
)xx 
]xx  
publicyy 
asyncyy 
Taskyy 
<yy 
ActionResultyy &
>yy& '
AddImageyy( 0
(yy0 1
ImageAddDtoyy1 <
imageDtoyy= E
)yyE F
{zz 	
try{{ 
{|| 
await}} 
_imagesHandler}} $
.}}$ %
AddImageAsync}}% 2
(}}2 3
imageDto}}3 ;
)}}; <
;}}< =
return~~ 
Ok~~ 
(~~ 
)~~ 
;~~ 
}
ÄÄ 
catch
ÅÅ 
(
ÅÅ 
	Exception
ÅÅ 
ex
ÅÅ 
)
ÅÅ  
{
ÇÇ 
return
ÉÉ 

BadRequest
ÉÉ !
(
ÉÉ! "
ex
ÉÉ" $
.
ÉÉ$ %
Message
ÉÉ% ,
)
ÉÉ, -
;
ÉÉ- .
}
ÑÑ 
}
ÖÖ 	
[
ÜÜ 	
	Authorize
ÜÜ	 
(
ÜÜ 
Roles
ÜÜ 
=
ÜÜ 
$str
ÜÜ #
)
ÜÜ# $
]
ÜÜ$ %
[
áá 	

HttpDelete
áá	 
(
áá 
$str
áá #
)
áá# $
]
áá$ %
public
àà 
async
àà 
Task
àà 
<
àà 
ActionResult
àà &
>
àà& '
RemoveImage
àà( 3
(
àà3 4
int
àà4 7
id
àà8 :
)
àà: ;
{
ââ 	
try
ää 
{
ãã 
await
åå 
_imagesHandler
åå $
.
åå$ %
RemoveImageAsync
åå% 5
(
åå5 6
id
åå6 8
)
åå8 9
;
åå9 :
return
çç 
Ok
çç 
(
çç 
)
çç 
;
çç 
}
èè 
catch
êê 
(
êê 
	Exception
êê 
ex
êê 
)
êê  
{
ëë 
return
íí 

BadRequest
íí !
(
íí! "
ex
íí" $
.
íí$ %
Message
íí% ,
)
íí, -
;
íí- .
}
ìì 
}
îî 	
[
ïï 	
	Authorize
ïï	 
(
ïï 
Roles
ïï 
=
ïï 
$str
ïï "
)
ïï" #
]
ïï# $
[
ññ 	
	HttpPatch
ññ	 
(
ññ 
$str
ññ !
)
ññ! "
]
ññ" #
public
óó 
async
óó 
Task
óó 
<
óó 
ActionResult
óó &
>
óó& '
UpdateStatus
óó( 4
(
óó4 5(
UserConsoleStatusUpdateDto
óó5 O
	updateDto
óóP Y
)
óóY Z
{
òò 	
try
ôô 
{
öö 
await
õõ "
_userConsolesHandler
õõ *
.
õõ* +
UpdateStatus
õõ+ 7
(
õõ7 8
	updateDto
õõ8 A
,
õõA B
User
õõC G
)
õõG H
;
õõH I
return
úú 
Ok
úú 
(
úú 
)
úú 
;
úú 
}
ûû 
catch
üü 
(
üü 
	Exception
üü 
ex
üü 
)
üü  
{
†† 
return
°° 

BadRequest
°° !
(
°°! "
ex
°°" $
.
°°$ %
Message
°°% ,
)
°°, -
;
°°- .
}
¢¢ 
}
££ 	
[
§§ 	
	Authorize
§§	 
(
§§ 
Roles
§§ 
=
§§ 
$str
§§ #
)
§§# $
]
§§$ %
[
•• 	
	HttpPatch
••	 
(
•• 
$str
•• )
)
••) *
]
••* +
public
¶¶ 
async
¶¶ 
Task
¶¶ 
<
¶¶ 
ActionResult
¶¶ &
>
¶¶& ''
TerminateContractByLender
¶¶( A
(
¶¶A B
int
¶¶B E
id
¶¶F H
)
¶¶H I
{
ßß 	
try
®® 
{
©© 
await
™™ "
_userConsolesHandler
™™ *
.
™™* +
UpdateStatus
™™+ 7
(
™™7 8
new
™™8 ;(
UserConsoleStatusUpdateDto
™™< V
{
™™W X
Id
™™Y [
=
™™\ ]
id
™™^ `
,
™™` a
ConsoleStatus
™™b o
=
™™p q
Data
™™r v
.
™™v w
Models
™™w }
.
™™} ~ 
UserConsoleStatus™™~ è
.™™è ê.
AWAITING_TERMINATION_BY_LENDER™™ê Æ
}™™Ø ∞
,™™∞ ±
User™™≤ ∂
)™™∂ ∑
;™™∑ ∏
return
´´ 
Ok
´´ 
(
´´ 
)
´´ 
;
´´ 
}
≠≠ 
catch
ÆÆ 
(
ÆÆ 
	Exception
ÆÆ 
ex
ÆÆ 
)
ÆÆ  
{
ØØ 
return
∞∞ 

BadRequest
∞∞ !
(
∞∞! "
ex
∞∞" $
.
∞∞$ %
Message
∞∞% ,
)
∞∞, -
;
∞∞- .
}
±± 
}
≤≤ 	
[
≥≥ 	
	Authorize
≥≥	 
(
≥≥ 
Roles
≥≥ 
=
≥≥ 
$str
≥≥ %
)
≥≥% &
]
≥≥& '
[
¥¥ 	
	HttpPatch
¥¥	 
(
¥¥ 
$str
¥¥ +
)
¥¥+ ,
]
¥¥, -
public
µµ 
async
µµ 
Task
µµ 
<
µµ 
ActionResult
µµ &
>
µµ& ')
TerminateContractByBorrower
µµ( C
(
µµC D
int
µµD G
id
µµH J
)
µµJ K
{
∂∂ 	
try
∑∑ 
{
∏∏ 
await
ππ "
_userConsolesHandler
ππ *
.
ππ* +
UpdateStatus
ππ+ 7
(
ππ7 8
new
ππ8 ;(
UserConsoleStatusUpdateDto
ππ< V
{
ππW X
Id
ππY [
=
ππ\ ]
id
ππ^ `
,
ππ` a
ConsoleStatus
ππb o
=
ππp q
Data
ππr v
.
ππv w
Models
ππw }
.
ππ} ~ 
UserConsoleStatusππ~ è
.ππè ê0
 AWAITING_TERMINATION_BY_BORROWERππê ∞
}ππ± ≤
,ππ≤ ≥
Userππ¥ ∏
)ππ∏ π
;πππ ∫
return
∫∫ 
Ok
∫∫ 
(
∫∫ 
)
∫∫ 
;
∫∫ 
}
ºº 
catch
ΩΩ 
(
ΩΩ 
	Exception
ΩΩ 
ex
ΩΩ 
)
ΩΩ  
{
ææ 
return
øø 

BadRequest
øø !
(
øø! "
ex
øø" $
.
øø$ %
Message
øø% ,
)
øø, -
;
øø- .
}
¿¿ 
}
¡¡ 	
}
¬¬ 
}√√ ∑n
r/home/karolis/Github/Univeras/7-semestras/Program≈≥ Sistem≈≥ Testavimas/PST/Backend/Controllers/UsersController.cs
	namespace

 	
Backend


 
.

 
Controllers

 
{ 
[ 
ApiController 
] 
[ 
Route 

(
 
$str 
) 
] 
[ 
	Authorize 
] 
public 

class 
UsersController  
:! "
ControllerBase# 1
{ 
private 
readonly 
IMapper  
_mapper! (
;( )
private 
readonly 
UsersHandler %
_handler& .
;. /
public 
UsersController 
( 
IMapper &
mapper' -
,- .
UsersHandler/ ;
handler< C
)C D
{ 	
_mapper 
= 
mapper 
; 
_handler 
= 
handler 
; 
} 	
[ 	
	Authorize	 
( 
Roles 
= 
$str "
)" #
]# $
[ 	
HttpGet	 
( 
$str 
)  
]  !
public 
async 
Task 
< 
ActionResult &
>& '
GetAllUsers( 3
(3 4
string4 :
?: ;
roleName< D
)D E
{ 	
try 
{ 
List   
<   
UserGet   
>   
users   #
=  $ %
_mapper  & -
.  - .
Map  . 1
<  1 2
List  2 6
<  6 7
User  7 ;
>  ; <
,  < =
List  > B
<  B C
UserGet  C J
>  J K
>  K L
(  L M
await  M R
_handler  S [
.  [ \
GetUsers  \ d
(  d e
roleName  e m
)  m n
)  n o
;  o p
return!! 
Ok!! 
(!! 
users!! 
)!!  
;!!  !
}"" 
catch## 
(## 
	Exception## 
e## 
)## 
{$$ 
return%% 

BadRequest%% !
(%%! "
e%%" #
.%%# $
Message%%$ +
)%%+ ,
;%%, -
}&& 
}'' 	
[(( 	
AllowAnonymous((	 
](( 
[)) 	
HttpPost))	 
()) 
$str))  
)))  !
]))! "
public** 
async** 
Task** 
<** 
ActionResult** &
>**& '
ConfirmEmail**( 4
(**4 5
[**5 6
FromBody**6 >
]**> ?!
UserEmailConfirmation**@ U
token**V [
)**[ \
{++ 	
try,, 
{-- 
token.. 
... 
Token.. 
=.. 
token.. #
...# $
Token..$ )
...) *
Replace..* 1
(..1 2
$char..2 5
,..5 6
$char..7 :
)..: ;
;..; <
await// 
_handler// 
.// 
ConfirmEmail// +
(//+ ,
token//, 1
.//1 2
Token//2 7
)//7 8
;//8 9
return00 
Ok00 
(00 
)00 
;00 
}11 
catch22 
(22 
	Exception22 
e22 
)22 
{33 
return44 

BadRequest44 !
(44! "
e44" #
.44# $
Message44$ +
)44+ ,
;44, -
}55 
}66 	
[77 	
AllowAnonymous77	 
]77 
[88 	
HttpPost88	 
(88 
$str88 &
)88& '
]88' (
public99 
async99 
Task99 
<99 
ActionResult99 &
>99& '"
SendPasswordResetEmail99( >
(99> ?
UserForgotPassword99? Q
data99R V
)99V W
{:: 	
try;; 
{<< 
var== 
message== 
=== 
await== #
_handler==$ ,
.==, -&
GeneratePasswordResetEmail==- G
(==G H
data==H L
.==L M
Email==M R
)==R S
;==S T
MailService>> 
.>> 
	SendEmail>> %
(>>% &
message>>& -
)>>- .
;>>. /
return?? 
Ok?? 
(?? 
)?? 
;?? 
}@@ 
catchAA 
(AA 
	ExceptionAA 
eAA 
)AA 
{BB 
returnCC 

BadRequestCC !
(CC! "
eCC" #
.CC# $
MessageCC$ +
)CC+ ,
;CC, -
}DD 
}EE 	
[GG 	
AllowAnonymousGG	 
]GG 
[HH 	
HttpPostHH	 
(HH 
$strHH (
)HH( )
]HH) *
publicII 
asyncII 
TaskII 
<II 
ActionResultII &
>II& '
ResetPasswordII( 5
(II5 6
[II6 7
FromBodyII7 ?
]II? @
UserPasswordResetIIA R
infoIIS W
)IIW X
{JJ 	
tryKK 
{LL 
infoMM 
.MM 
	ResetCodeMM 
=MM  
infoMM! %
.MM% &
	ResetCodeMM& /
.MM/ 0
ReplaceMM0 7
(MM7 8
$charMM8 ;
,MM; <
$charMM= @
)MM@ A
;MMA B
awaitNN 
_handlerNN 
.NN 
ResetPasswordNN ,
(NN, -
infoNN- 1
.NN1 2
	ResetCodeNN2 ;
,NN; <
infoNN= A
.NNA B
NewPasswordNNB M
)NNM N
;NNN O
returnOO 
OkOO 
(OO 
)OO 
;OO 
}PP 
catchQQ 
(QQ 
	ExceptionQQ 
eQQ 
)QQ 
{RR 
returnSS 

BadRequestSS !
(SS! "
eSS" #
.SS# $
MessageSS$ +
)SS+ ,
;SS, -
}TT 
}UU 	
[WW 	
HttpPutWW	 
(WW 
$strWW *
)WW* +
]WW+ ,
publicXX 
asyncXX 
TaskXX 
<XX 
ActionResultXX &
>XX& '
UpdatePhysicalXX( 6
(XX6 7
[XX7 8
FromBodyXX8 @
]XX@ A
UserPhysicalUpdateXXB T
dataXXU Y
)XXY Z
{YY 	
tryZZ 
{[[ 
await\\ 
_handler\\ 
.\\ 
UpdatePhysical\\ -
(\\- .
User\\. 2
,\\2 3
data\\4 8
)\\8 9
;\\9 :
return]] 
Ok]] 
(]] 
)]] 
;]] 
}^^ 
catch__ 
(__ 
	Exception__ 
e__ 
)__ 
{`` 
returnaa 

BadRequestaa !
(aa! "
eaa" #
.aa# $
Messageaa$ +
)aa+ ,
;aa, -
}bb 
}cc 	
[ee 	
HttpPutee	 
(ee 
$stree '
)ee' (
]ee( )
publicff 
asyncff 
Taskff 
<ff 
ActionResultff &
>ff& '
UpdateLegalff( 3
(ff3 4
[ff4 5
FromBodyff5 =
]ff= >
UserLegalUpdateff? N
dataffO S
)ffS T
{gg 	
tryhh 
{ii 
awaitjj 
_handlerjj 
.jj 
UpdateLegaljj *
(jj* +
Userjj+ /
,jj/ 0
datajj1 5
)jj5 6
;jj6 7
returnkk 
Okkk 
(kk 
)kk 
;kk 
}ll 
catchmm 
(mm 
	Exceptionmm 
emm 
)mm 
{nn 
returnoo 

BadRequestoo !
(oo! "
eoo" #
.oo# $
Messageoo$ +
)oo+ ,
;oo, -
}pp 
}qq 	
[ss 	
HttpPutss	 
(ss 
$strss )
)ss) *
]ss* +
publictt 
asynctt 
Tasktt 
<tt 
ActionResulttt &
>tt& '
UpdateAddresstt( 5
(tt5 6
[tt6 7
FromBodytt7 ?
]tt? @
UserAddressUpdatettA R
datattS W
)ttW X
{uu 	
tryvv 
{ww 
awaitxx 
_handlerxx 
.xx 
UpdateAddressxx ,
(xx, -
Userxx- 1
,xx1 2
dataxx3 7
)xx7 8
;xx8 9
returnyy 
Okyy 
(yy 
)yy 
;yy 
}zz 
catch{{ 
({{ 
	Exception{{ 
e{{ 
){{ 
{|| 
return}} 

BadRequest}} !
(}}! "
e}}" #
.}}# $
Message}}$ +
)}}+ ,
;}}, -
}~~ 
} 	
[
ÅÅ 	
HttpPost
ÅÅ	 
(
ÅÅ 
$str
ÅÅ *
)
ÅÅ* +
]
ÅÅ+ ,
public
ÇÇ 
async
ÇÇ 
Task
ÇÇ 
<
ÇÇ 
ActionResult
ÇÇ &
>
ÇÇ& '
ChangePassword
ÇÇ( 6
(
ÇÇ6 7
[
ÇÇ7 8
FromBody
ÇÇ8 @
]
ÇÇ@ A 
UserPasswordChange
ÇÇB T
passwordInfo
ÇÇU a
)
ÇÇa b
{
ÉÉ 	
try
ÑÑ 
{
ÖÖ 
await
ÜÜ 
_handler
ÜÜ 
.
ÜÜ 
ChangePassword
ÜÜ -
(
ÜÜ- .
User
ÜÜ. 2
,
ÜÜ2 3
passwordInfo
ÜÜ4 @
)
ÜÜ@ A
;
ÜÜA B
return
áá 
Ok
áá 
(
áá 
)
áá 
;
áá 
}
àà 
catch
ââ 
(
ââ 
	Exception
ââ 
e
ââ 
)
ââ 
{
ää 
return
ãã 

BadRequest
ãã !
(
ãã! "
e
ãã" #
.
ãã# $
Message
ãã$ +
)
ãã+ ,
;
ãã, -
}
åå 
}
çç 	
[
éé 	
HttpPost
éé	 
(
éé 
$str
éé $
)
éé$ %
]
éé% &
public
èè 
async
èè 
Task
èè 
<
èè 
ActionResult
èè &
>
èè& '"
SendEmailChangeToken
èè( <
(
èè< =
[
èè= >
FromBody
èè> F
]
èèF G
UserEmailChange
èèH W
data
èèX \
)
èè\ ]
{
êê 	
try
ëë 
{
íí 
var
ìì 
message
ìì 
=
ìì 
await
ìì #
_handler
ìì$ ,
.
ìì, --
GenerateEmailAddressChangeEmail
ìì- L
(
ììL M
User
ììM Q
,
ììQ R
data
ììS W
.
ììW X
NewEmail
ììX `
)
ìì` a
;
ììa b
MailService
îî 
.
îî 
	SendEmail
îî %
(
îî% &
message
îî& -
)
îî- .
;
îî. /
return
ïï 
Ok
ïï 
(
ïï 
)
ïï 
;
ïï 
}
ññ 
catch
óó 
(
óó 
	Exception
óó 
e
óó 
)
óó 
{
òò 
return
ôô 

BadRequest
ôô !
(
ôô! "
e
ôô" #
.
ôô# $
Message
ôô$ +
)
ôô+ ,
;
ôô, -
}
öö 
}
õõ 	
[
ùù 	
HttpGet
ùù	 
(
ùù 
$str
ùù -
)
ùù- .
]
ùù. /
public
ûû 
async
ûû 
Task
ûû 
<
ûû 
ActionResult
ûû &
>
ûû& '"
GetUnconfirmedEmails
ûû( <
(
ûû< =
)
ûû= >
{
üü 	
try
†† 
{
°° 
var
¢¢ 
emails
¢¢ 
=
¢¢ 
await
¢¢ "
_handler
¢¢# +
.
¢¢+ ,"
GetUnconfirmedEmails
¢¢, @
(
¢¢@ A
User
¢¢A E
)
¢¢E F
;
¢¢F G
return
££ 
Ok
££ 
(
££ 
emails
££  
)
££  !
;
££! "
}
§§ 
catch
•• 
(
•• 
	Exception
•• 
e
•• 
)
•• 
{
¶¶ 
return
ßß 

BadRequest
ßß !
(
ßß! "
e
ßß" #
.
ßß# $
Message
ßß$ +
)
ßß+ ,
;
ßß, -
}
®® 
}
©© 	
[
™™ 	
AllowAnonymous
™™	 
]
™™ 
[
´´ 	
HttpPost
´´	 
(
´´ 
$str
´´ &
)
´´& '
]
´´' (
public
¨¨ 
async
¨¨ 
Task
¨¨ 
<
¨¨ 
ActionResult
¨¨ &
>
¨¨& '
ChangeEmail
¨¨( 3
(
¨¨3 4
[
¨¨4 5
FromBody
¨¨5 =
]
¨¨= >#
UserEmailConfirmation
¨¨? T
token
¨¨U Z
)
¨¨Z [
{
≠≠ 	
try
ÆÆ 
{
ØØ 
token
∞∞ 
.
∞∞ 
Token
∞∞ 
=
∞∞ 
token
∞∞ #
.
∞∞# $
Token
∞∞$ )
.
∞∞) *
Replace
∞∞* 1
(
∞∞1 2
$char
∞∞2 5
,
∞∞5 6
$char
∞∞7 :
)
∞∞: ;
;
∞∞; <
await
±± 
_handler
±± 
.
±± 
ChangeEmail
±± *
(
±±* +
token
±±+ 0
.
±±0 1
Token
±±1 6
)
±±6 7
;
±±7 8
return
≤≤ 
Ok
≤≤ 
(
≤≤ 
)
≤≤ 
;
≤≤ 
}
≥≥ 
catch
¥¥ 
(
¥¥ 
	Exception
¥¥ 
e
¥¥ 
)
¥¥ 
{
µµ 
return
∂∂ 

BadRequest
∂∂ !
(
∂∂! "
e
∂∂" #
.
∂∂# $
Message
∂∂$ +
)
∂∂+ ,
;
∂∂, -
}
∑∑ 
}
∏∏ 	
}
ππ 
}∫∫ àí
k/home/karolis/Github/Univeras/7-semestras/Program≈≥ Sistem≈≥ Testavimas/PST/Backend/Handlers/AuthHandler.cs
	namespace 	
Backend
 
. 
Handlers 
{ 
public 

class 
AuthHandler 
{ 
private 
readonly 
UserManager $
<$ %
User% )
>) *
_userManager+ 7
;7 8
private 
readonly 
SignInManager &
<& '
User' +
>+ ,
_signInManager- ;
;; <
private 
readonly 
IMapper  
_mapper! (
;( )
private 
readonly 
AppDbContext %
_context& .
;. /
private 
readonly 
UsersHandler %
_usersHandler& 3
;3 4
private 
readonly 
bool 
_disableMail *
;* +
public 
AuthHandler 
( 
UserManager &
<& '
User' +
>+ ,
userManager- 8
,8 9
SignInManager: G
<G H
UserH L
>L M
signInManagerN [
,[ \
IMapper] d
mappere k
,k l
AppDbContextm y
context	z Å
,
Å Ç
UsersHandler
É è
usersHandler
ê ú
,
ú ù
bool
û ¢
disableMail
£ Æ
=
Ø ∞
false
± ∂
)
∂ ∑
{ 	
_userManager 
= 
userManager &
;& '
_signInManager 
= 
signInManager *
;* +
_mapper 
= 
mapper 
; 
_context 
= 
context 
; 
_usersHandler 
= 
usersHandler (
;( )
_disableMail 
= 
disableMail &
;& '
} 	
private   
async   
Task   
<   
User   
>    
GetUser  ! (
(  ( )
	UserLogin  ) 2
data  3 7
)  7 8
{!! 	
MailAddress"" 
_"" 
;"" 
return## 
MailAddress## 
.## 
	TryCreate## (
(##( )
data##) -
.##- .
UserName##. 6
,##6 7
out##8 ;
_##< =
)##= >
?##? @
await$$ 
_userManager$$ "
.$$" #
FindByEmailAsync$$# 3
($$3 4
data$$4 8
.$$8 9
UserName$$9 A
)$$A B
:$$C D
await%% 
_userManager%% "
.%%" #
FindByNameAsync%%# 2
(%%2 3
data%%3 7
.%%7 8
UserName%%8 @
)%%@ A
;%%A B
}&& 	
public(( 
async(( 
Task(( 
<(( 
UserGet(( !
>((! "
Login((# (
(((( )
	UserLogin(() 2
data((3 7
)((7 8
{)) 	
var** 
user** 
=** 
await** 
GetUser** $
(**$ %
data**% )
)**) *
;*** +
if++ 
(++ 
user++ 
is++ 
null++ 
)++ 
{,, 
throw-- 
new-- 
ArgumentException-- +
(--+ ,
$str--, M
)--M N
;--N O
}.. 
if// 
(// 
!// 
user// 
.// 
EmailConfirmed// $
)//$ %
{00 
throw11 
new11 
ArgumentException11 +
(11+ ,
$str11, N
)11N O
;11O P
}22 
var33 
signInResult33 
=33 
await33 $
_signInManager33% 3
.333 4
PasswordSignInAsync334 G
(33G H
user33H L
,33L M
data33N R
.33R S
Password33S [
,33[ \
data33] a
.33a b
RememberPassword33b r
,33r s
false33t y
)33y z
;33z {
if55 
(55 
!55 
signInResult55 
.55 
	Succeeded55 '
)55' (
{66 
throw77 
new77 
ArgumentException77 +
(77+ ,
$str77, M
)77M N
;77N O
}88 
var:: 
userGet:: 
=:: 
_mapper:: !
.::! "
Map::" %
<::% &
UserGet::& -
>::- .
(::. /
user::/ 3
)::3 4
;::4 5
userGet;; 
.;; 
Role;; 
=;; 
(;; 
await;; !
_userManager;;" .
.;;. /
GetRolesAsync;;/ <
(;;< =
user;;= A
);;A B
);;B C
.;;C D
First;;D I
(;;I J
);;J K
;;;K L
return== 
userGet== 
;== 
}>> 	
public@@ 
async@@ 
Task@@ 
<@@ 
bool@@ 
>@@ 
Logout@@  &
(@@& '
)@@' (
{AA 	
awaitBB 
_signInManagerBB  
.BB  !
SignOutAsyncBB! -
(BB- .
)BB. /
;BB/ 0
returnCC 
trueCC 
;CC 
}DD 	
publicEE 
asyncEE 
TaskEE 
<EE 
UserGetEE !
>EE! "

GetProfileEE# -
(EE- .
ClaimsPrincipalEE. =
claimsEE> D
)EED E
{FF 	
varGG 
userGG 
=GG 
awaitGG 
_userManagerGG )
.GG) *
GetUserAsyncGG* 6
(GG6 7
claimsGG7 =
)GG= >
;GG> ?
ifII 
(II 
userII 
isII 
nullII 
)II 
{JJ 
returnKK 
nullKK 
;KK 
}LL 
varNN 
userGetNN 
=NN 
_mapperNN !
.NN! "
MapNN" %
<NN% &
UserGetNN& -
>NN- .
(NN. /
userNN/ 3
)NN3 4
;NN4 5
userGetOO 
.OO 
RoleOO 
=OO 
(OO 
awaitOO !
_userManagerOO" .
.OO. /
GetRolesAsyncOO/ <
(OO< =
userOO= A
)OOA B
)OOB C
.OOC D
FirstOOD I
(OOI J
)OOJ K
;OOK L
returnQQ 
userGetQQ 
;QQ 
}RR 	
publicTT 
asyncTT 
TaskTT 
RegisterTT "
(TT" #
RegisterPhysicalTT# 3
dataTT4 8
)TT8 9
{UU 	
varVV 
userVV 
=VV 
_mapperVV 
.VV 
MapVV "
<VV" #
UserVV# '
>VV' (
(VV( )
dataVV) -
)VV- .
;VV. /
userWW 
.WW 
UserNameWW 
=WW 
dataWW  
.WW  !
EmailWW! &
;WW& '
varYY 
resultYY 
=YY 
awaitYY 
_userManagerYY +
.YY+ ,
CreateAsyncYY, 7
(YY7 8
userYY8 <
,YY< =
dataYY> B
.YYB C
PasswordYYC K
)YYK L
;YYL M
if[[ 
([[ 
result[[ 
.[[ 
	Succeeded[[  
)[[  !
{\\ 
await]] 
_userManager]] "
.]]" #
AddToRoleAsync]]# 1
(]]1 2
user]]2 6
,]]6 7
$str]]8 @
)]]@ A
;]]A B
User^^ 
createdUser^^  
=^^! "
(^^# $
await^^$ )
_userManager^^* 6
.^^6 7
FindByEmailAsync^^7 G
(^^G H
user^^H L
.^^L M
Email^^M R
!^^R S
)^^S T
)^^T U
!^^U V
;^^V W
var__ 
message__ 
=__ 
await__ #
_usersHandler__$ 1
.__1 2%
GenerateConfirmationEmail__2 K
(__K L
createdUser__L W
)__W X
;__X Y
if`` 
(`` 
!`` 
_disableMail`` !
)``! "
MailServiceaa 
.aa  
	SendEmailaa  )
(aa) *
messageaa* 1
)aa1 2
;aa2 3
returnbb 
;bb 
}cc 
elsedd 
{ee 
stringff 
errorsff 
=ff 
stringff  &
.ff& '
Joinff' +
(ff+ ,
$strff, 0
,ff0 1
resultff2 8
.ff8 9
Errorsff9 ?
.ff? @
Selectff@ F
(ffF G
effG H
=>ffI K
effL M
.ffM N
DescriptionffN Y
)ffY Z
)ffZ [
;ff[ \
throwgg 
newgg 
	Exceptiongg #
(gg# $
errorsgg$ *
)gg* +
;gg+ ,
}hh 
}ii 	
publickk 
asynckk 
Taskkk 
Registerkk "
(kk" #
RegisterLegalkk# 0
datakk1 5
)kk5 6
{ll 	
varmm 
usermm 
=mm 
_mappermm 
.mm 
Mapmm "
<mm" #
Usermm# '
>mm' (
(mm( )
datamm) -
)mm- .
;mm. /
usernn 
.nn 
UserNamenn 
=nn 
datann  
.nn  !
Emailnn! &
;nn& '
useroo 
.oo 
	IsCompanyoo 
=oo 
falseoo "
;oo" #
varqq 
resultqq 
=qq 
awaitqq 
_userManagerqq +
.qq+ ,
CreateAsyncqq, 7
(qq7 8
userqq8 <
,qq< =
dataqq> B
.qqB C
PasswordqqC K
)qqK L
;qqL M
ifss 
(ss 
resultss 
.ss 
	Succeededss  
)ss  !
{tt 
awaituu 
_userManageruu "
.uu" #
AddToRoleAsyncuu# 1
(uu1 2
useruu2 6
,uu6 7
$struu8 @
)uu@ A
;uuA B
Uservv 
createdUservv  
=vv! "
awaitvv# (
_userManagervv) 5
.vv5 6
FindByEmailAsyncvv6 F
(vvF G
uservvG K
.vvK L
EmailvvL Q
)vvQ R
;vvR S
varww 
messageww 
=ww 
awaitww #
_usersHandlerww$ 1
.ww1 2%
GenerateConfirmationEmailww2 K
(wwK L
createdUserwwL W
)wwW X
;wwX Y
ifxx 
(xx 
!xx 
_disableMailxx !
)xx! "
MailServiceyy 
.yy  
	SendEmailyy  )
(yy) *
messageyy* 1
)yy1 2
;yy2 3
returnzz 
;zz 
}{{ 
else|| 
{}} 
string~~ 
errors~~ 
=~~ 
string~~  &
.~~& '
Join~~' +
(~~+ ,
$str~~, 0
,~~0 1
result~~2 8
.~~8 9
Errors~~9 ?
.~~? @
Select~~@ F
(~~F G
e~~G H
=>~~I K
e~~L M
.~~M N
Description~~N Y
)~~Y Z
)~~Z [
;~~[ \
throw 
new 
	Exception #
(# $
errors$ *
)* +
;+ ,
}
ÄÄ 
}
ÅÅ 	
public
ÉÉ 
async
ÉÉ 
Task
ÉÉ 
<
ÉÉ 
List
ÉÉ 
<
ÉÉ !
RegistrationRequest
ÉÉ 2
>
ÉÉ2 3
>
ÉÉ3 4%
GetRegistrationRequests
ÉÉ5 L
(
ÉÉL M
)
ÉÉM N
{
ÑÑ 	
return
ÖÖ 
_context
ÖÖ 
.
ÖÖ "
RegistrationRequests
ÖÖ 0
.
ÖÖ0 1
Select
ÖÖ1 7
(
ÖÖ7 8
x
ÖÖ8 9
=>
ÖÖ: <
x
ÖÖ= >
)
ÖÖ> ?
.
ÖÖ? @
ToList
ÖÖ@ F
(
ÖÖF G
)
ÖÖG H
;
ÖÖH I
}
ÜÜ 	
public
àà 
async
àà 
Task
àà 
<
àà !
RegistrationRequest
àà -
>
àà- .'
SubmitRegistrationRequest
àà/ H
(
ààH I!
RegistrationRequest
ààI \
request
àà] d
)
ààd e
{
ââ 	
request
ää 
.
ää 
DateCreated
ää 
=
ää  !
DateTime
ää" *
.
ää* +
Now
ää+ .
;
ää. /
var
ãã 
result
ãã 
=
ãã 
_context
ãã !
.
ãã! ""
RegistrationRequests
ãã" 6
.
ãã6 7
Add
ãã7 :
(
ãã: ;
request
ãã; B
)
ããB C
;
ããC D
await
çç 
_context
çç 
.
çç 
SaveChangesAsync
çç +
(
çç+ ,
)
çç, -
;
çç- .
return
èè 
result
èè 
.
èè 
Entity
èè  
;
èè  !
}
êê 	
public
ëë 
async
ëë 
Task
ëë 
<
ëë 
bool
ëë 
>
ëë (
ApproveRegistrationRequest
ëë  :
(
ëë: ;)
RegistrationRequestApproval
ëë; V
requestApproval
ëëW f
)
ëëf g
{
íí 	
var
îî 
request
îî 
=
îî 
await
îî 
_context
îî  (
.
îî( )"
RegistrationRequests
îî) =
.
îî= >
Where
îî> C
(
îîC D
x
îîD E
=>
îîF H
x
îîI J
.
îîJ K
Id
îîK M
==
îîN P
requestApproval
îîQ `
.
îî` a
	RequestId
îîa j
)
îîj k
.
îîk l!
FirstOrDefaultAsync
îîl 
(îî Ä
)îîÄ Å
;îîÅ Ç
if
ïï 
(
ïï 
request
ïï 
==
ïï 
null
ïï 
)
ïï  
{
ññ 
throw
óó 
new
óó )
ArgumentOutOfRangeException
óó 5
(
óó5 6
$str
óó6 [
)
óó[ \
;
óó\ ]
}
òò 
_context
öö 
.
öö "
RegistrationRequests
öö )
.
öö) *
Remove
öö* 0
(
öö0 1
request
öö1 8
)
öö8 9
;
öö9 :
await
õõ 
_context
õõ 
.
õõ 
SaveChangesAsync
õõ +
(
õõ+ ,
)
õõ, -
;
õõ- .
if
ùù 
(
ùù 
!
ùù 
requestApproval
ùù  
.
ùù  !

IsApproved
ùù! +
)
ùù+ ,
{
ûû 
return
üü 
false
üü 
;
üü 
}
†† 
RegisterLegal
¢¢ 
dto
¢¢ 
=
¢¢ 
_mapper
¢¢  '
.
¢¢' (
Map
¢¢( +
<
¢¢+ ,!
RegistrationRequest
¢¢, ?
,
¢¢? @
RegisterLegal
¢¢A N
>
¢¢N O
(
¢¢O P
request
¢¢P W
)
¢¢W X
;
¢¢X Y
try
§§ 
{
•• 
await
¶¶  
RegisterAsBorrower
¶¶ (
(
¶¶( )
dto
¶¶) ,
)
¶¶, -
;
¶¶- .
return
ßß 
true
ßß 
;
ßß 
}
®® 
catch
©© 
(
©© 
	Exception
©© 
ex
©© 
)
©©  
{
™™ 
throw
´´ 
new
´´ 
	Exception
´´ #
(
´´# $
ex
´´$ &
.
´´& '
Message
´´' .
)
´´. /
;
´´/ 0
}
¨¨ 
}
≠≠ 	
private
ÆÆ 
async
ÆÆ 
Task
ÆÆ  
RegisterAsBorrower
ÆÆ -
(
ÆÆ- .
RegisterLegal
ÆÆ. ;
data
ÆÆ< @
)
ÆÆ@ A
{
ØØ 	
var
∞∞ 
user
∞∞ 
=
∞∞ 
_mapper
∞∞ 
.
∞∞ 
Map
∞∞ "
<
∞∞" #
User
∞∞# '
>
∞∞' (
(
∞∞( )
data
∞∞) -
)
∞∞- .
;
∞∞. /
user
±± 
.
±± 
UserName
±± 
=
±± 
data
±±  
.
±±  !
Email
±±! &
;
±±& '
user
≤≤ 
.
≤≤ 
	IsCompany
≤≤ 
=
≤≤ 
true
≤≤ !
;
≤≤! "
var
≥≥ 
result
≥≥ 
=
≥≥ 
await
≥≥ 
_userManager
≥≥ +
.
≥≥+ ,
CreateAsync
≥≥, 7
(
≥≥7 8
user
≥≥8 <
,
≥≥< =
data
≥≥> B
.
≥≥B C
Password
≥≥C K
)
≥≥K L
;
≥≥L M
if
µµ 
(
µµ 
result
µµ 
.
µµ 
	Succeeded
µµ  
)
µµ  !
{
∂∂ 
await
∑∑ 
_userManager
∑∑ "
.
∑∑" #
AddToRoleAsync
∑∑# 1
(
∑∑1 2
user
∑∑2 6
,
∑∑6 7
$str
∑∑8 B
)
∑∑B C
;
∑∑C D
User
∏∏ 
createdUser
∏∏  
=
∏∏! "
await
∏∏# (
_userManager
∏∏) 5
.
∏∏5 6
FindByEmailAsync
∏∏6 F
(
∏∏F G
user
∏∏G K
.
∏∏K L
Email
∏∏L Q
)
∏∏Q R
;
∏∏R S
var
ππ 
message
ππ 
=
ππ 
await
ππ #
_usersHandler
ππ$ 1
.
ππ1 2'
GenerateConfirmationEmail
ππ2 K
(
ππK L
createdUser
ππL W
)
ππW X
;
ππX Y
if
∫∫ 
(
∫∫ 
!
∫∫ 
_disableMail
∫∫ !
)
∫∫! "
MailService
ªª 
.
ªª  
	SendEmail
ªª  )
(
ªª) *
message
ªª* 1
)
ªª1 2
;
ªª2 3
return
ºº 
;
ºº 
}
ΩΩ 
else
ææ 
{
øø 
string
¿¿ 
errors
¿¿ 
=
¿¿ 
string
¿¿  &
.
¿¿& '
Join
¿¿' +
(
¿¿+ ,
$str
¿¿, 0
,
¿¿0 1
result
¿¿2 8
.
¿¿8 9
Errors
¿¿9 ?
.
¿¿? @
Select
¿¿@ F
(
¿¿F G
e
¿¿G H
=>
¿¿I K
e
¿¿L M
.
¿¿M N
Description
¿¿N Y
)
¿¿Y Z
)
¿¿Z [
;
¿¿[ \
throw
¡¡ 
new
¡¡ 
	Exception
¡¡ #
(
¡¡# $
errors
¡¡$ *
)
¡¡* +
;
¡¡+ ,
}
¬¬ 
}
√√ 	
}
≈≈ 
}∆∆ ßÜ
q/home/karolis/Github/Univeras/7-semestras/Program≈≥ Sistem≈≥ Testavimas/PST/Backend/Handlers/BorrowingsHandler.cs
	namespace 	
Backend
 
. 
Handlers 
{ 
public 

class 
BorrowingsHandler "
{ 
private 
readonly 
IMapper  
_mapper! (
;( )
private 
readonly 
AppDbContext %
_context& .
;. /
private 
readonly 
UserManager $
<$ %
User% )
>) *
_userManager+ 7
;7 8
private 
readonly 
UserConsolesHandler , 
_userConsolesHandler- A
;A B
public 
BorrowingsHandler  
(  !
IMapper! (
mapper) /
,/ 0
AppDbContext1 =
context> E
,E F
UserManagerG R
<R S
UserS W
>W X
userManagerY d
,d e
UserConsolesHandlerf y 
userConsolesHandler	z ç
)
ç é
{ 	
_mapper 
= 
mapper 
; 
_context 
= 
context 
; 
_userManager 
= 
userManager &
;& ' 
_userConsolesHandler  
=! "
userConsolesHandler# 6
;6 7
} 	
public 
async 
Task 
< 
List 
< 
BorrowingGetDto .
>. /
>/ 0
GetAllAsync1 <
(< =
)= >
{ 	
return 
_mapper 
. 
Map 
< 
List #
<# $
	Borrowing$ -
>- .
,. /
List0 4
<4 5
BorrowingGetDto5 D
>D E
>E F
(F G
awaitG L
_contextM U
.U V

BorrowingsV `
.` a
Includea h
(h i
xi j
=>k m
xn o
.o p
UserConsolesp |
)| }
.} ~
ThenInclude	~ â
(
â ä
x
ä ã
=>
å é
x
è ê
.
ê ë
Images
ë ó
)
ó ò
.
ò ô
Include
ô †
(
† °
x
° ¢
=>
£ •
x
¶ ß
.
ß ®
UserConsoles
® ¥
)
¥ µ
.
µ ∂
ThenInclude
∂ ¡
(
¡ ¬
x
¬ √
=>
ƒ ∆
x
« »
.
» …
Console
… –
)
– —
.
— “
ToListAsync
“ ›
(
› ﬁ
)
ﬁ ﬂ
)
ﬂ ‡
;
‡ ·
} 	
public   
async   
Task   
<   
List   
<   
BorrowingGetDto   .
>  . /
>  / 0
GetByUserAsync  1 ?
(  ? @
ClaimsPrincipal  @ O

userClaims  P Z
)  Z [
{!! 	
User"" 
user"" 
="" 
await"" 
_userManager"" *
.""* +
GetUserAsync""+ 7
(""7 8

userClaims""8 B
)""B C
;""C D
return## 
_mapper## 
.## 
Map## 
<## 
List## #
<### $
	Borrowing##$ -
>##- .
,##. /
List##0 4
<##4 5
BorrowingGetDto##5 D
>##D E
>##E F
(##F G
await##G L
_context##M U
.##U V

Borrowings##V `
.##` a
Include##a h
(##h i
x##i j
=>##k m
x##n o
.##o p
UserConsoles##p |
)##| }
.##} ~
ThenInclude	##~ â
(
##â ä
x
##ä ã
=>
##å é
x
##è ê
.
##ê ë
Images
##ë ó
)
##ó ò
.
##ò ô
Include
##ô †
(
##† °
x
##° ¢
=>
##£ •
x
##¶ ß
.
##ß ®
UserConsoles
##® ¥
)
##¥ µ
.
##µ ∂
ThenInclude
##∂ ¡
(
##¡ ¬
x
##¬ √
=>
##ƒ ∆
x
##« »
.
##» …
Console
##… –
)
##– —
.
##— “
Where
##“ ◊
(
##◊ ÿ
x
##ÿ Ÿ
=>
##Ÿ €
x
##€ ‹
.
##‹ ›
UserId
##› „
==
##‰ Ê
user
##Á Î
.
##Î Ï
Id
##Ï Ó
)
##Ó Ô
.
##Ô 
ToListAsync
## ˚
(
##˚ ¸
)
##¸ ˝
)
##˝ ˛
;
##˛ ˇ
}$$ 	
public%% 
async%% 
Task%% 
<%% 
BorrowingGetDto%% )
>%%) *
GetByIdAsync%%+ 7
(%%7 8
int%%8 ;
id%%< >
)%%> ?
{&& 	
return'' 
_mapper'' 
.'' 
Map'' 
<'' 
	Borrowing'' (
,''( )
BorrowingGetDto''* 9
>''9 :
('': ;
await''; @
_context''A I
.''I J

Borrowings''J T
.''T U
Include''U \
(''\ ]
x''] ^
=>''^ `
x''` a
.''a b
User''b f
)''f g
.''g h
Include''h o
(''o p
x''p q
=>''r t
x''u v
.''v w
UserConsoles	''w É
)
''É Ñ
.
''Ñ Ö
ThenInclude
''Ö ê
(
''ê ë
x
''ë í
=>
''ì ï
x
''ñ ó
.
''ó ò
Images
''ò û
)
''û ü
.
''ü †
Include
''† ß
(
''ß ®
x
''® ©
=>
''™ ¨
x
''≠ Æ
.
''Æ Ø
UserConsoles
''Ø ª
)
''ª º
.
''º Ω
ThenInclude
''Ω »
(
''» …
x
''…  
=>
''À Õ
x
''Œ œ
.
''œ –
Console
''– ◊
)
''◊ ÿ
.
''ÿ Ÿ
Where
''Ÿ ﬁ
(
''ﬁ ﬂ
x
''ﬂ ‡
=>
''‡ ‚
x
''‚ „
.
''„ ‰
Id
''‰ Ê
==
''Á È
id
''Í Ï
)
''Ï Ì
.
''Ì Ó

FirstAsync
''Ó ¯
(
''¯ ˘
)
''˘ ˙
)
''˙ ˚
;
''˚ ¸
}(( 	
public)) 
async)) 
Task)) 
AddAsync)) "
())" #
BorrowingAddDto))# 2
addDto))3 9
,))9 :
ClaimsPrincipal)); J

userClaims))K U
)))U V
{** 	
User++ 
user++ 
=++ 
await++ 
_userManager++ *
.++* +
GetUserAsync+++ 7
(++7 8

userClaims++8 B
)++B C
;++C D
var-- 
result-- 
=-- 
_context-- !
.--! "

Borrowings--" ,
.--, -
Add--- 0
(--0 1
new--1 4
	Borrowing--5 >
{--? @
UserId--A G
=--H I
user--J N
.--N O
Id--O Q
,--Q R
Status--S Y
=--Z [
BorrowingStatus--\ k
.--k l
PENDING--l s
}--t u
)--u v
;--v w
await.. 
_context.. 
... 
SaveChangesAsync.. +
(..+ ,
).., -
;..- .
async00 
Task00 
UpdateUserConsole00 (
(00( )
int00) ,
userConsoleId00- :
,00: ;
int00< ?
borrowingId00@ K
)00K L
{11 
var22 
userConsole22 
=22  !
await22" '
_context22( 0
.220 1
UserConsoles221 =
.22= >
Where22> C
(22C D
x22D E
=>22F H
x22I J
.22J K
Id22K M
==22N P
userConsoleId22Q ^
)22^ _
.22_ `

FirstAsync22` j
(22j k
)22k l
;22l m
userConsole44 
.44 
BorrowingId44 '
=44( )
borrowingId44* 5
;445 6
userConsole55 
.55 
ConsoleStatus55 )
=55* +
UserConsoleStatus55, =
.55= >
RESERVED55> F
;55F G
_context77 
.77 
UserConsoles77 %
.77% &
Update77& ,
(77, -
userConsole77- 8
)778 9
;779 :
await88 
_context88 
.88 
SaveChangesAsync88 /
(88/ 0
)880 1
;881 2
}99 
foreach<< 
(<< 
var<< 
id<< 
in<< 
addDto<< $
.<<$ %
UserConsoleIds<<% 3
)<<3 4
{== 
var>> 
userConsole>> 
=>>  !
await>>" '
_context>>( 0
.>>0 1
UserConsoles>>1 =
.>>= >
Where>>> C
(>>C D
x>>D E
=>>>E G
x>>G H
.>>H I
Id>>I K
==>>L N
id>>O Q
)>>Q R
.>>R S

FirstAsync>>S ]
(>>] ^
)>>^ _
;>>_ `
if?? 
(?? 
userConsole?? 
==?? !
null??" &
||??' )
userConsole??* 5
.??5 6
ConsoleStatus??6 C
!=??D F
UserConsoleStatus??G X
.??X Y
AT_PLATFORM??Y d
)??d e
{@@ 
continueAA 
;AA 
}BB 
awaitCC 
UpdateUserConsoleCC '
(CC' (
idCC( *
,CC* +
resultCC, 2
.CC2 3
EntityCC3 9
.CC9 :
IdCC: <
)CC< =
;CC= >
}DD 
}EE 	
publicGG 
asyncGG 
TaskGG 
UpdateAsyncGG %
(GG% &
BorrowingUpdateDtoGG& 8
	updateDtoGG9 B
,GGB C
ClaimsPrincipalGGD S

userClaimsGGT ^
)GG^ _
{HH 	
varLL "
originalUserConsoleIdsLL &
=LL' (
awaitLL) .
_contextLL/ 7
.LL7 8
UserConsolesLL8 D
.LLD E
WhereLLE J
(LLJ K
xLLK L
=>LLM O
xLLP Q
.LLQ R
BorrowingIdLLR ]
==LL^ `
	updateDtoLLa j
.LLj k
IdLLk m
)LLm n
.LLn o
SelectLLo u
(LLu v
xLLv w
=>LLx z
xLL{ |
.LL| }
IdLL} 
)	LL Ä
.
LLÄ Å
ToListAsync
LLÅ å
(
LLå ç
)
LLç é
;
LLé è
foreachNN 
(NN 
varNN 
idNN 
inNN "
originalUserConsoleIdsNN 5
)NN5 6
{OO 
awaitPP  
_userConsolesHandlerPP *
.PP* +
UpdateStatusPP+ 7
(PP7 8
newPP8 ;&
UserConsoleStatusUpdateDtoPP< V
{PPW X
IdPPY [
=PP\ ]
idPP^ `
,PP` a
ConsoleStatusPPb o
=PPp q
UserConsoleStatus	PPr É
.
PPÉ Ñ
AT_PLATFORM
PPÑ è
}
PPê ë
,
PPë í

userClaims
PPì ù
)
PPù û
;
PPû ü
}QQ 
foreachSS 
(SS 
varSS 
idSS 
inSS 
	updateDtoSS '
.SS' (
UserConsoleIdsSS( 6
)SS6 7
{TT 
awaitUU  
_userConsolesHandlerUU *
.UU* +
UpdateStatusUU+ 7
(UU7 8
newUU8 ;&
UserConsoleStatusUpdateDtoUU< V
{UUW X
IdUUY [
=UU\ ]
idUU^ `
,UU` a
ConsoleStatusUUb o
=UUp q
UserConsoleStatus	UUr É
.
UUÉ Ñ
	AT_LENDER
UUÑ ç
}
UUé è
,
UUè ê

userClaims
UUë õ
)
UUõ ú
;
UUú ù
}VV 
}WW 	
publicXX 
asyncXX 
TaskXX 
UpdateStatusAsyncXX +
(XX+ ,$
BorrowingUpdateStatusDtoXX, D
	statusDtoXXE N
)XXN O
{YY 	
varZZ 
userConsolesZZ 
=ZZ 
awaitZZ $
_contextZZ% -
.ZZ- .
UserConsolesZZ. :
.ZZ: ;
WhereZZ; @
(ZZ@ A
xZZA B
=>ZZC E
xZZF G
.ZZG H
BorrowingIdZZH S
==ZZT V
	statusDtoZZW `
.ZZ` a
IdZZa c
)ZZc d
.ZZd e
ToListAsyncZZe p
(ZZp q
)ZZq r
;ZZr s
async\\ 
Task\\ 
UpdateUserConsole\\ (
(\\( )
int\\) ,
userConsoleId\\- :
,\\: ;
UserConsoleStatus\\< M
status\\N T
)\\T U
{]] 
var^^ 
userConsole^^ 
=^^  !
await^^" '
_context^^( 0
.^^0 1
UserConsoles^^1 =
.^^= >
Where^^> C
(^^C D
x^^D E
=>^^F H
x^^I J
.^^J K
Id^^K M
==^^N P
userConsoleId^^Q ^
)^^^ _
.^^_ `

FirstAsync^^` j
(^^j k
)^^k l
;^^l m
userConsole`` 
.`` 
ConsoleStatus`` )
=``* +
status``, 2
;``2 3
_contextbb 
.bb 
UserConsolesbb %
.bb% &
Updatebb& ,
(bb, -
userConsolebb- 8
)bb8 9
;bb9 :
awaitcc 
_contextcc 
.cc 
SaveChangesAsynccc /
(cc/ 0
)cc0 1
;cc1 2
}dd 
varff 
	borrowingff 
=ff 
awaitff !
_contextff" *
.ff* +

Borrowingsff+ 5
.ff5 6
Whereff6 ;
(ff; <
xff< =
=>ff> @
xffA B
.ffB C
IdffC E
==ffF H
	statusDtoffI R
.ffR S
IdffS U
)ffU V
.ffV W

FirstAsyncffW a
(ffa b
)ffb c
;ffc d
	borrowinggg 
.gg 
Statusgg 
=gg 
	statusDtogg (
.gg( )
BorrowingStatusgg) 8
;gg8 9
awaithh 
_contexthh 
.hh 
SaveChangesAsynchh +
(hh+ ,
)hh, -
;hh- .
ifjj 
(jj 
	statusDtojj 
.jj 
BorrowingStatusjj (
==jj) +
BorrowingStatusjj, ;
.jj; <
ACTIVEjj< B
)jjB C
{kk 
foreachll 
(ll 
varll 
userConsolell '
inll( *
userConsolesll+ 7
)ll7 8
{mm 
awaitnn 
UpdateUserConsolenn +
(nn+ ,
userConsolenn, 7
.nn7 8
Idnn8 :
,nn: ;
UserConsoleStatusnn< M
.nnM N
	AT_LENDERnnN W
)nnW X
;nnX Y
}oo 
}pp 
}qq 	
publicrr 
asyncrr 
Taskrr 
DeleteAsyncrr %
(rr% &
intrr& )
idrr* ,
)rr, -
{ss 	
vartt 
conversationtt 
=tt 
awaittt $
_contexttt% -
.tt- .
Conversationstt. ;
.tt; <
Wherett< A
(ttA B
xttB C
=>ttC E
xttE F
.ttF G
BorrowingIdttG R
==ttS U
idttV X
)ttX Y
.ttY Z
FirstOrDefaultAsyncttZ m
(ttm n
)ttn o
;tto p
ifuu 
(uu 
conversationuu 
!=uu 
nulluu #
)uu# $
{vv 
_contextww 
.ww 
Conversationsww &
.ww& '
Removeww' -
(ww- .
conversationww. :
)ww: ;
;ww; <
}xx 
varzz 
	borrowingzz 
=zz 
awaitzz !
_contextzz" *
.zz* +

Borrowingszz+ 5
.zz5 6
Wherezz6 ;
(zz; <
xzz< =
=>zz= ?
xzz? @
.zz@ A
IdzzA C
==zzD F
idzzG I
)zzI J
.zzJ K

FirstAsynczzK U
(zzU V
)zzV W
;zzW X
_context|| 
.|| 

Borrowings|| 
.||  
Remove||  &
(||& '
	borrowing||' 0
)||0 1
;||1 2
await}} 
_context}} 
.}} 
SaveChangesAsync}} +
(}}+ ,
)}}, -
;}}- .
}~~ 	
public
ÄÄ 
bool
ÄÄ 
	CanDelete
ÄÄ 
(
ÄÄ 
int
ÄÄ !
id
ÄÄ" $
)
ÄÄ$ %
{
ÅÅ 	
return
ÇÇ 
!
ÇÇ 
_context
ÇÇ 
.
ÇÇ 
UserConsoles
ÇÇ )
.
ÇÇ) *
Where
ÇÇ* /
(
ÇÇ/ 0
x
ÇÇ0 1
=>
ÇÇ1 3
x
ÇÇ3 4
.
ÇÇ4 5
BorrowingId
ÇÇ5 @
==
ÇÇA C
id
ÇÇD F
)
ÇÇF G
.
ÇÇG H
Any
ÇÇH K
(
ÇÇK L
)
ÇÇL M
;
ÇÇM N
}
ÉÉ 	
}
ÑÑ 
}ÖÖ ‹£
l/home/karolis/Github/Univeras/7-semestras/Program≈≥ Sistem≈≥ Testavimas/PST/Backend/Handlers/ChatsHandler.cs
	namespace 	
Backend
 
. 
Handlers 
{ 
public 

class 
ChatsHandler 
{ 
private 
readonly 
AppDbContext %
_context& .
;. /
private 
readonly 
UserManager $
<$ %
User% )
>) *
_userManager+ 7
;7 8
private 
readonly 
IMapper  
_mapper! (
;( )
private 
readonly 
FilesHandler %
_filesHandler& 3
;3 4
public 
ChatsHandler 
( 
AppDbContext (
context) 0
,0 1
UserManager2 =
<= >
User> B
>B C
userManagerD O
,O P
IMapperQ X
mapperY _
,_ `
FilesHandlera m
filesHandlern z
)z {
{ 	
_context 
= 
context 
; 
_userManager 
= 
userManager &
;& '
_mapper 
= 
mapper 
; 
_filesHandler 
= 
filesHandler (
;( )
} 	
public 
async 
Task 
< 
List 
< 
ConversationGetDto 1
>1 2
>2 3
GetAllConversations4 G
(G H
)H I
{ 	
List 
< 
ConversationGetDto #
># $
conversationGets% 5
=6 7
_mapper8 ?
.? @
Map@ C
<C D
ListD H
<H I
ConversationI U
>U V
,V W
ListX \
<\ ]
ConversationGetDto] o
>o p
>p q
(q r
awaitr w
_context	x Ä
.
Ä Å
Conversations
Å é
.
é è
Include
è ñ
(
ñ ó
x
ó ò
=>
ô õ
x
ú ù
.
ù û
Messages
û ¶
)
¶ ß
.
ß ®
ThenInclude
® ≥
(
≥ ¥
x
¥ µ
=>
∂ ∏
x
π ∫
.
∫ ª
MessageFiles
ª «
)
« »
.
» …
Include
… –
(
– —
x
— “
=>
” ’
x
÷ ◊
.
◊ ÿ
	Borrowing
ÿ ·
)
· ‚
.
‚ „
Include
„ Í
(
Í Î
x
Î Ï
=>
Ì Ô
x
 Ò
.
Ò Ú
UserConsole
Ú ˝
)
˝ ˛
.
˛ ˇ
ThenInclude
ˇ ä
(
ä ã
x
ã å
=>
ç è
x
ê ë
.
ë í
Console
í ô
)
ô ö
.
ö õ
Include
õ ¢
(
¢ £
x
£ §
=>
• ß
x
® ©
.
© ™
UserConsole
™ µ
)
µ ∂
.
∂ ∑
ThenInclude
∑ ¬
(
¬ √
x
√ ƒ
=>
≈ «
x
» …
.
…  
Images
  –
)
– —
.
— “
ToListAsync
“ ›
(
› ﬁ
)
ﬁ ﬂ
)
ﬂ ‡
;
‡ ·
return 
conversationGets #
.# $
Where$ )
() *
x* +
=>, .
x/ 0
.0 1
Messages1 9
.9 :
Count: ?
>@ A
$numB C
)C D
.D E
OrderByDescendingE V
(V W
xW X
=>Y [
x\ ]
.] ^
Messages^ f
.f g
Maxg j
(j k
xk l
=>m o
xp q
.q r
DateSentr z
)z {
){ |
.| }
ToList	} É
(
É Ñ
)
Ñ Ö
.
Ö Ü
Union
Ü ã
(
ã å
conversationGets
å ú
)
ú ù
.
ù û
ToList
û §
(
§ •
)
• ¶
;
¶ ß
}   	
public!! 
async!! 
Task!! 
<!! 
List!! 
<!! 
ConversationGetDto!! 1
>!!1 2
>!!2 3"
GetLenderConversations!!4 J
(!!J K
ClaimsPrincipal!!K Z

userClaims!![ e
)!!e f
{"" 	
var## 
user## 
=## 
await## 
_userManager## )
.##) *
GetUserAsync##* 6
(##6 7

userClaims##7 A
)##A B
;##B C
var$$ 
userConsoleIds$$ 
=$$  
_context$$! )
.$$) *
UserConsoles$$* 6
.$$6 7
Where$$7 <
($$< =
x$$= >
=>$$? A
x$$B C
.$$C D
UserId$$D J
==$$K M
user$$N R
.$$R S
Id$$S U
)$$U V
.$$V W
Select$$W ]
($$] ^
x$$^ _
=>$$` b
x$$c d
.$$d e
Id$$e g
)$$g h
.$$h i
ToList$$i o
($$o p
)$$p q
;$$q r
List%% 
<%% 
ConversationGetDto%% #
>%%# $
conversationGets%%% 5
=%%6 7
_mapper%%8 ?
.%%? @
Map%%@ C
<%%C D
List%%D H
<%%H I
Conversation%%I U
>%%U V
,%%V W
List%%X \
<%%\ ]
ConversationGetDto%%] o
>%%o p
>%%p q
(%%q r
await%%r w
_context	%%x Ä
.
%%Ä Å
Conversations
%%Å é
.
%%é è
Where
%%è î
(
%%î ï
x
%%ï ñ
=>
%%ó ô
x
%%ö õ
.
%%õ ú
UserConsoleId
%%ú ©
!=
%%™ ¨
null
%%≠ ±
)
%%± ≤
.
%%≤ ≥
Where
%%≥ ∏
(
%%∏ π
x
%%π ∫
=>
%%ª Ω
userConsoleIds
%%æ Ã
.
%%Ã Õ
Contains
%%Õ ’
(
%%’ ÷
x
%%÷ ◊
.
%%◊ ÿ
UserConsoleId
%%ÿ Â
??
%%Ê Ë
-
%%È Í
$num
%%Í Î
)
%%Î Ï
)
%%Ï Ì
.
%%Ì Ó
Include
%%Ó ı
(
%%ı ˆ
x
%%ˆ ˜
=>
%%¯ ˙
x
%%˚ ¸
.
%%¸ ˝
Messages
%%˝ Ö
)
%%Ö Ü
.
%%Ü á
ThenInclude
%%á í
(
%%í ì
x
%%ì î
=>
%%ï ó
x
%%ò ô
.
%%ô ö
MessageFiles
%%ö ¶
)
%%¶ ß
.
%%ß ®
Include
%%® Ø
(
%%Ø ∞
x
%%∞ ±
=>
%%≤ ¥
x
%%µ ∂
.
%%∂ ∑
UserConsole
%%∑ ¬
)
%%¬ √
.
%%√ ƒ
ThenInclude
%%ƒ œ
(
%%œ –
x
%%– —
=>
%%“ ‘
x
%%’ ÷
.
%%÷ ◊
Console
%%◊ ﬁ
)
%%ﬁ ﬂ
.
%%ﬂ ‡
Include
%%‡ Á
(
%%Á Ë
x
%%Ë È
=>
%%Í Ï
x
%%Ì Ó
.
%%Ó Ô
UserConsole
%%Ô ˙
)
%%˙ ˚
.
%%˚ ¸
ThenInclude
%%¸ á
(
%%á à
x
%%à â
=>
%%ä å
x
%%ç é
.
%%é è
Images
%%è ï
)
%%ï ñ
.
%%ñ ó
ToListAsync
%%ó ¢
(
%%¢ £
)
%%£ §
)
%%§ •
;
%%• ¶
return&& 
conversationGets&& #
.&&# $
Where&&$ )
(&&) *
x&&* +
=>&&, .
x&&/ 0
.&&0 1
Messages&&1 9
.&&9 :
Count&&: ?
>&&@ A
$num&&B C
)&&C D
.&&D E
OrderByDescending&&E V
(&&V W
x&&W X
=>&&Y [
x&&\ ]
.&&] ^
Messages&&^ f
.&&f g
Max&&g j
(&&j k
x&&k l
=>&&m o
x&&p q
.&&q r
DateSent&&r z
)&&z {
)&&{ |
.&&| }
ToList	&&} É
(
&&É Ñ
)
&&Ñ Ö
.
&&Ö Ü
Union
&&Ü ã
(
&&ã å
conversationGets
&&å ú
)
&&ú ù
.
&&ù û
ToList
&&û §
(
&&§ •
)
&&• ¶
;
&&¶ ß
}'' 	
public(( 
async(( 
Task(( 
<(( 
List(( 
<(( 
ConversationGetDto(( 1
>((1 2
>((2 3$
GetBorrowerConversations((4 L
(((L M
ClaimsPrincipal((M \

userClaims((] g
)((g h
{)) 	
var** 
user** 
=** 
await** 
_userManager** )
.**) *
GetUserAsync*** 6
(**6 7

userClaims**7 A
)**A B
;**B C
var++ 
borrowingIds++ 
=++ 
_context++ '
.++' (

Borrowings++( 2
.++2 3
Where++3 8
(++8 9
x++9 :
=>++; =
x++> ?
.++? @
UserId++@ F
==++G I
user++J N
.++N O
Id++O Q
)++Q R
.++R S
Select++S Y
(++Y Z
x++Z [
=>++\ ^
x++_ `
.++` a
Id++a c
)++c d
.++d e
ToList++e k
(++k l
)++l m
;++m n
List,, 
<,, 
ConversationGetDto,, #
>,,# $
conversationGets,,% 5
=,,6 7
_mapper,,8 ?
.,,? @
Map,,@ C
<,,C D
List,,D H
<,,H I
Conversation,,I U
>,,U V
,,,V W
List,,X \
<,,\ ]
ConversationGetDto,,] o
>,,o p
>,,p q
(,,q r
await,,r w
_context	,,x Ä
.
,,Ä Å
Conversations
,,Å é
.
,,é è
Where
,,è î
(
,,î ï
x
,,ï ñ
=>
,,ó ô
x
,,ö õ
.
,,õ ú
BorrowingId
,,ú ß
!=
,,® ™
null
,,´ Ø
)
,,Ø ∞
.
,,∞ ±
Where
,,± ∂
(
,,∂ ∑
x
,,∑ ∏
=>
,,π ª
borrowingIds
,,º »
.
,,» …
Contains
,,… —
(
,,— “
x
,,“ ”
.
,,” ‘
BorrowingId
,,‘ ﬂ
??
,,‡ ‚
-
,,„ ‰
$num
,,‰ Â
)
,,Â Ê
)
,,Ê Á
.
,,Á Ë
Include
,,Ë Ô
(
,,Ô 
x
,, Ò
=>
,,Ú Ù
x
,,ı ˆ
.
,,ˆ ˜
Messages
,,˜ ˇ
)
,,ˇ Ä
.
,,Ä Å
ThenInclude
,,Å å
(
,,å ç
x
,,ç é
=>
,,è ë
x
,,í ì
.
,,ì î
MessageFiles
,,î †
)
,,† °
.
,,° ¢
Include
,,¢ ©
(
,,© ™
x
,,™ ´
=>
,,¨ Æ
x
,,Ø ∞
.
,,∞ ±
	Borrowing
,,± ∫
)
,,∫ ª
.
,,ª º
ThenInclude
,,º «
(
,,« »
x
,,» …
=>
,,  Ã
x
,,Õ Œ
.
,,Œ œ
UserConsoles
,,œ €
)
,,€ ‹
.
,,‹ ›
ThenInclude
,,› Ë
(
,,Ë È
x
,,È Í
=>
,,Î Ì
x
,,Ó Ô
.
,,Ô 
Images
,, ˆ
)
,,ˆ ˜
.
,,˜ ¯
ToListAsync
,,¯ É
(
,,É Ñ
)
,,Ñ Ö
)
,,Ö Ü
;
,,Ü á
return-- 
conversationGets-- #
.--# $
Where--$ )
(--) *
x--* +
=>--, .
x--/ 0
.--0 1
Messages--1 9
.--9 :
Count--: ?
>--@ A
$num--B C
)--C D
.--D E
OrderByDescending--E V
(--V W
x--W X
=>--Y [
x--\ ]
.--] ^
Messages--^ f
.--f g
Max--g j
(--j k
x--k l
=>--m o
x--p q
.--q r
DateSent--r z
)--z {
)--{ |
.--| }
ToList	--} É
(
--É Ñ
)
--Ñ Ö
.
--Ö Ü
Union
--Ü ã
(
--ã å
conversationGets
--å ú
)
--ú ù
.
--ù û
ToList
--û §
(
--§ •
)
--• ¶
;
--¶ ß
}.. 	
public00 
async00 
Task00 
<00 
ConversationGetDto00 ,
>00, -
GetConversation00. =
(00= >
int00> A
userConsoleId00B O
)00O P
{11 	
return22 
_mapper22 
.22 
Map22 
<22 
Conversation22 +
,22+ ,
ConversationGetDto22- ?
>22? @
(22@ A
await22A F
_context22G O
.22O P
Conversations22P ]
.22] ^
Include22^ e
(22e f
x22f g
=>22h j
x22k l
.22l m
Messages22m u
)22u v
.22v w
ThenInclude	22w Ç
(
22Ç É
x
22É Ñ
=>
22Ö á
x
22à â
.
22â ä
MessageFiles
22ä ñ
)
22ñ ó
.
22ó ò
Include
22ò ü
(
22ü †
x
22† °
=>
22¢ §
x
22• ¶
.
22¶ ß
UserConsole
22ß ≤
)
22≤ ≥
.
22≥ ¥
ThenInclude
22¥ ø
(
22ø ¿
x
22¿ ¡
=>
22¬ ƒ
x
22≈ ∆
.
22∆ «
Console
22« Œ
)
22Œ œ
.
22œ –
Include
22– ◊
(
22◊ ÿ
x
22ÿ Ÿ
=>
22⁄ ‹
x
22› ﬁ
.
22ﬁ ﬂ
UserConsole
22ﬂ Í
)
22Í Î
.
22Î Ï
ThenInclude
22Ï ˜
(
22˜ ¯
x
22¯ ˘
=>
22˙ ¸
x
22˝ ˛
.
22˛ ˇ
Images
22ˇ Ö
)
22Ö Ü
.
22Ü á
Where
22á å
(
22å ç
x
22ç é
=>
22è ë
x
22í ì
.
22ì î
UserConsoleId
22î °
==
22¢ §
userConsoleId
22• ≤
)
22≤ ≥
.
22≥ ¥!
FirstOrDefaultAsync
22¥ «
(
22« »
)
22» …
)
22…  
;
22  À
}33 	
public44 
async44 
Task44 
ContactLender44 '
(44' (
int44( +
userConsoleId44, 9
)449 :
{55 	
if66 
(66 
await66 
_context66 
.66 
Conversations66 ,
.66, -
Where66- 2
(662 3
x663 4
=>665 7
x668 9
.669 :
UserConsoleId66: G
==66H J
userConsoleId66K X
)66X Y
.66Y Z
FirstOrDefaultAsync66Z m
(66m n
)66n o
!=66p r
null66s w
)66w x
{77 
return88 
;88 
}99 
var:: 
result:: 
=:: 
_context:: !
.::! "
Conversations::" /
.::/ 0
Add::0 3
(::3 4
new::4 7
Conversation::8 D
{::E F
UserConsoleId::G T
=::U V
userConsoleId::W d
}::e f
)::f g
;::g h
await;; 
_context;; 
.;; 
SaveChangesAsync;; +
(;;+ ,
);;, -
;;;- .
var== 
userConsole== 
=== 
_context== &
.==& '
UserConsoles==' 3
.==3 4
Where==4 9
(==9 :
x==: ;
=>==< >
x==? @
.==@ A
Id==A C
====D F
userConsoleId==G T
)==T U
.==U V
First==V [
(==[ \
)==\ ]
;==] ^
userConsole>> 
.>> 
ConversationId>> &
=>>' (
result>>) /
.>>/ 0
Entity>>0 6
.>>6 7
Id>>7 9
;>>9 :
_context?? 
.?? 
UserConsoles?? !
.??! "
Update??" (
(??( )
userConsole??) 4
)??4 5
;??5 6
awaitAA 
_contextAA 
.AA 
SaveChangesAsyncAA +
(AA+ ,
)AA, -
;AA- .
returnBB 
;BB 
}CC 	
publicDD 
asyncDD 
TaskDD 
ContactBorrowerDD )
(DD) *
intDD* -
borrowingIdDD. 9
)DD9 :
{EE 	
ifFF 
(FF 
awaitFF 
_contextFF 
.FF 
ConversationsFF ,
.FF, -
WhereFF- 2
(FF2 3
xFF3 4
=>FF5 7
xFF8 9
.FF9 :
BorrowingIdFF: E
==FFF H
borrowingIdFFI T
)FFT U
.FFU V
FirstOrDefaultAsyncFFV i
(FFi j
)FFj k
!=FFl n
nullFFo s
)FFs t
{GG 
returnHH 
;HH 
}II 
varJJ 
resultJJ 
=JJ 
_contextJJ !
.JJ! "
ConversationsJJ" /
.JJ/ 0
AddJJ0 3
(JJ3 4
newJJ4 7
ConversationJJ8 D
{JJE F
BorrowingIdJJG R
=JJS T
borrowingIdJJU `
}JJa b
)JJb c
;JJc d
awaitKK 
_contextKK 
.KK 
SaveChangesAsyncKK +
(KK+ ,
)KK, -
;KK- .
varMM 
	borrowingMM 
=MM 
awaitMM !
_contextMM" *
.MM* +

BorrowingsMM+ 5
.MM5 6
WhereMM6 ;
(MM; <
xMM< =
=>MM> @
xMMA B
.MMB C
IdMMC E
==MMF H
borrowingIdMMI T
)MMT U
.MMU V

FirstAsyncMMV `
(MM` a
)MMa b
;MMb c
	borrowingNN 
.NN 
ConversationIdNN $
=NN% &
resultNN' -
.NN- .
EntityNN. 4
.NN4 5
IdNN5 7
;NN7 8
_contextOO 
.OO 

BorrowingsOO 
.OO  
UpdateOO  &
(OO& '
	borrowingOO' 0
)OO0 1
;OO1 2
awaitQQ 
_contextQQ 
.QQ 
SaveChangesAsyncQQ +
(QQ+ ,
)QQ, -
;QQ- .
returnRR 
;RR 
}SS 	
publicTT 
asyncTT 
TaskTT 
SendMessageTT %
(TT% &
MessageAddDtoTT& 3
addDtoTT4 :
,TT: ;
ClaimsPrincipalTT< K

userClaimsTTL V
)TTV W
{UU 	
varVV 
userVV 
=VV 
awaitVV 
_userManagerVV )
.VV) *
GetUserAsyncVV* 6
(VV6 7

userClaimsVV7 A
)VVA B
;VVB C
varWW 
rolesWW 
=WW 
awaitWW 
_userManagerWW *
.WW* +
GetRolesAsyncWW+ 8
(WW8 9
userWW9 =
)WW= >
;WW> ?
ListXX 
<XX 
MessageFileAddDtoXX "
>XX" #
filesXX$ )
=XX* +
addDtoXX, 2
.XX2 3
FilesXX3 8
.XX8 9
ToListXX9 ?
(XX? @
)XX@ A
;XXA B
addDtoZZ 
.ZZ 
FilesZZ 
=ZZ 
nullZZ 
;ZZ  
var[[ 
result[[ 
=[[ 
_context[[ !
.[[! "
Messages[[" *
.[[* +
Add[[+ .
([[. /
new[[/ 2
Message[[3 :
{[[; <
ConversationId[[= K
=[[L M
addDto[[N T
.[[T U
ConversationId[[U c
,[[c d
Text[[e i
=[[j k
addDto[[l r
.[[r s
Text[[s w
,[[w x
	FromAdmin	[[y Ç
=
[[É Ñ
roles
[[Ö ä
[
[[ä ã
$num
[[ã å
]
[[å ç
.
[[ç é
ToLower
[[é ï
(
[[ï ñ
)
[[ñ ó
==
[[ò ö
$str
[[õ ¢
,
[[¢ £
DateSent
[[§ ¨
=
[[≠ Æ
DateTime
[[Ø ∑
.
[[∑ ∏
Now
[[∏ ª
}
[[º Ω
)
[[Ω æ
;
[[æ ø
await\\ 
_context\\ 
.\\ 
SaveChangesAsync\\ +
(\\+ ,
)\\, -
;\\- .
for__ 
(__ 
int__ 
i__ 
=__ 
$num__ 
;__ 
i__ 
<__ 
files__  %
.__% &
Count__& +
;__+ ,
i__- .
++__. 0
)__0 1
{`` 
filesaa 
[aa 
iaa 
]aa 
.aa 
	MessageIdaa "
=aa# $
resultaa% +
.aa+ ,
Entityaa, 2
.aa2 3
Idaa3 5
;aa5 6
awaitbb 
_filesHandlerbb #
.bb# $
AddMessageFileAsyncbb$ 7
(bb7 8
filesbb8 =
[bb= >
ibb> ?
]bb? @
)bb@ A
;bbA B
}cc 
}ee 	
}ff 
}gg ∆c
o/home/karolis/Github/Univeras/7-semestras/Program≈≥ Sistem≈≥ Testavimas/PST/Backend/Handlers/ConsolesHandler.cs
	namespace 	
Backend
 
. 
Handlers 
{		 
public

 

class

 
ConsolesHandler

  
{ 
private 
readonly 
AppDbContext %
_context& .
;. /
private 
readonly 
FilesHandler %
_imagesHandler& 4
;4 5
private 
readonly 
IMapper  
_mapper! (
;( )
public 
ConsolesHandler 
( 
AppDbContext +
context, 3
,3 4
FilesHandler5 A
imagesHandlerB O
,O P
IMapperQ X
mapperY _
)_ `
{ 	
_context 
= 
context 
; 
_imagesHandler 
= 
imagesHandler *
;* +
_mapper 
= 
mapper 
; 
} 	
public 
async 
Task 
< 
List 
< 
ConsoleGetDto ,
>, -
>- .
GetConsolesAsync/ ?
(? @
)@ A
{ 	
return 
_mapper 
. 
Map 
< 
List #
<# $
Data$ (
.( )
Models) /
./ 0
Console0 7
>7 8
,8 9
List: >
<> ?
ConsoleGetDto? L
>L M
>M N
(N O
awaitO T
_contextU ]
.] ^
Consoles^ f
.f g
Includeg n
(n o
co p
=>q s
ct u
.u v
Imagesv |
)| }
.} ~
ToListAsync	~ â
(
â ä
)
ä ã
)
ã å
;
å ç
} 	
public 
async 
Task 
< 
ConsoleGetDto '
>' (
GetConsoleAsync) 8
(8 9
int9 <
id= ?
)? @
{ 	
return 
_mapper 
. 
Map 
< 
Data #
.# $
Models$ *
.* +
Console+ 2
,2 3
ConsoleGetDto4 A
>A B
(B C
awaitC H
_contextI Q
.Q R
ConsolesR Z
.Z [
Include[ b
(b c
cc d
=>e g
ch i
.i j
Imagesj p
)p q
.q r
Wherer w
(w x
xx y
=>z |
x} ~
.~ 
Id	 Å
==
Ç Ñ
id
Ö á
)
á à
.
à â

FirstAsync
â ì
(
ì î
)
î ï
)
ï ñ
;
ñ ó
} 	
public 
async 
Task 
< 
ConsoleGetDto '
>' (
AddConsoleAsync) 8
(8 9
ConsoleAddDto9 F

consoleDtoG Q
)Q R
{   	
List!! 
<!! 
ImageAddDto!! 
>!! 
images!! $
=!!% &

consoleDto!!' 1
.!!1 2
Images!!2 8
.!!8 9
ToList!!9 ?
(!!? @
)!!@ A
;!!A B
Data$$ 
.$$ 
Models$$ 
.$$ 
Console$$ 
console$$  '
=$$( )
_mapper$$* 1
.$$1 2
Map$$2 5
<$$5 6
ConsoleAddDto$$6 C
,$$C D
Data$$E I
.$$I J
Models$$J P
.$$P Q
Console$$Q X
>$$X Y
($$Y Z

consoleDto$$Z d
)$$d e
;$$e f
console%% 
.%% 
Images%% 
=%% 
null%% !
;%%! "
var&& 
res&& 
=&& 
_context&& 
.&& 
Consoles&& '
.&&' (
Add&&( +
(&&+ ,
console&&, 3
)&&3 4
;&&4 5
await'' 
_context'' 
.'' 
SaveChangesAsync'' +
(''+ ,
)'', -
;''- .
for** 
(** 
int** 
i** 
=** 
$num** 
;** 
i** 
<** 
images**  &
.**& '
Count**' ,
;**, -
i**. /
++**/ 1
)**1 2
{++ 
images,, 
[,, 
i,, 
],, 
.,, 
	ConsoleId,, #
=,,$ %
res,,& )
.,,) *
Entity,,* 0
.,,0 1
Id,,1 3
;,,3 4
await-- 
_imagesHandler-- $
.--$ %
AddImageAsync--% 2
(--2 3
images--3 9
[--9 :
i--: ;
]--; <
)--< =
;--= >
}.. 
Data00 
.00 
Models00 
.00 
Console00 
result00  &
=00' (
_context00) 1
.001 2
Consoles002 :
.00: ;
Include00; B
(00B C
x00C D
=>00E G
x00H I
.00I J
Images00J P
)00P Q
.00Q R
Where00R W
(00W X
x00X Y
=>00Z \
x00] ^
.00^ _
Id00_ a
==00b d
res00e h
.00h i
Entity00i o
.00o p
Id00p r
)00r s
.00s t
First00t y
(00y z
)00z {
;00{ |
return11 
_mapper11 
.11 
Map11 
<11 
Data11 #
.11# $
Models11$ *
.11* +
Console11+ 2
,112 3
ConsoleGetDto114 A
>11A B
(11B C
result11C I
)11I J
;11J K
}22 	
public33 
async33 
Task33 
<33 
ConsoleGetDto33 '
>33' (
UpdateConsoleAsync33) ;
(33; <
ConsoleUpdateDto33< L

consoleDto33M W
)33W X
{44 	
List66 
<66 
ImageUpdateDto66 
>66  
images66! '
=66( )

consoleDto66* 4
.664 5
Images665 ;
.66; <
ToList66< B
(66B C
)66C D
;66D E
foreach77 
(77 
ImageUpdateDto77 #
image77$ )
in77* ,
images77- 3
)773 4
{88 
await99 
_imagesHandler99 $
.99$ %
UpdateImageAsync99% 5
(995 6
image996 ;
)99; <
;99< =
}:: 
Data== 
.== 
Models== 
.== 
Console== 
changes==  '
===( )
_mapper==* 1
.==1 2
Map==2 5
<==5 6
ConsoleUpdateDto==6 F
,==F G
Data==H L
.==L M
Models==M S
.==S T
Console==T [
>==[ \
(==\ ]

consoleDto==] g
)==g h
;==h i
Data?? 
.?? 
Models?? 
.?? 
Console?? 
original??  (
=??) *
_context??+ 3
.??3 4
Consoles??4 <
.??< =
First??= B
(??B C
x??C D
=>??E G
x??H I
.??I J
Id??J L
==??M O
changes??P W
.??W X
Id??X Z
)??Z [
;??[ \
foreach@@ 
(@@ 
PropertyInfo@@ !
info@@" &
in@@' )
original@@* 2
.@@2 3
GetType@@3 :
(@@: ;
)@@; <
.@@< =
GetProperties@@= J
(@@J K
)@@K L
)@@L M
{AA 
ifBB 
(BB 
infoBB 
.BB 
GetValueBB !
(BB! "
changesBB" )
)BB) *
==BB+ -
nullBB. 2
||BB3 5
infoBB6 :
.BB: ;
NameBB; ?
==BB@ B
$strBBC G
)BBG H
{CC 
continueDD 
;DD 
}EE 
infoFF 
.FF 
SetValueFF 
(FF 
originalFF &
,FF& '
infoFF( ,
.FF, -
GetValueFF- 5
(FF5 6
changesFF6 =
)FF= >
)FF> ?
;FF? @
}GG 
_contextII 
.II 
ConsolesII 
.II 
UpdateII $
(II$ %
originalII% -
)II- .
;II. /
awaitJJ 
_contextJJ 
.JJ 
SaveChangesAsyncJJ +
(JJ+ ,
)JJ, -
;JJ- .
DataLL 
.LL 
ModelsLL 
.LL 
ConsoleLL 
resultLL  &
=LL' (
_contextLL) 1
.LL1 2
ConsolesLL2 :
.LL: ;
IncludeLL; B
(LLB C
xLLC D
=>LLE G
xLLH I
.LLI J
ImagesLLJ P
)LLP Q
.LLQ R
WhereLLR W
(LLW X
xLLX Y
=>LLZ \
xLL] ^
.LL^ _
IdLL_ a
==LLb d

consoleDtoLLe o
.LLo p
IdLLp r
)LLr s
.LLs t
FirstLLt y
(LLy z
)LLz {
;LL{ |
returnMM 
_mapperMM 
.MM 
MapMM 
<MM 
DataMM #
.MM# $
ModelsMM$ *
.MM* +
ConsoleMM+ 2
,MM2 3
ConsoleGetDtoMM4 A
>MMA B
(MMB C
resultMMC I
)MMI J
;MMJ K
}NN 	
publicOO 
asyncOO 
TaskOO 
RemoveConsoleAsyncOO ,
(OO, -
intOO- 0
idOO1 3
)OO3 4
{PP 	
varQQ 
userConsolesQQ 
=QQ 
_contextQQ '
.QQ' (
UserConsolesQQ( 4
.QQ4 5
FirstOrDefaultQQ5 C
(QQC D
xQQD E
=>QQF H
xQQI J
.QQJ K
	ConsoleIdQQK T
==QQU W
idQQX Z
)QQZ [
;QQ[ \
ifRR 
(RR 
userConsolesRR 
isRR 
notRR  #
nullRR$ (
)RR( )
{SS 
throwTT 
newTT %
InvalidOperationExceptionTT 3
(TT3 4
$strTT4 _
)TT_ `
;TT` a
}UU 
ListXX 
<XX 
intXX 
>XX 
	imagesIdsXX 
=XX  !
(XX" #
awaitXX# (
_imagesHandlerXX) 7
.XX7 8!
GetConsoleImagesAsyncXX8 M
(XXM N
idXXN P
)XXP Q
)XXQ R
.XXR S
SelectXXS Y
(XXY Z
xXXZ [
=>XX\ ^
xXX_ `
.XX` a
IdXXa c
)XXc d
.XXd e
ToListXXe k
(XXk l
)XXl m
;XXm n
foreachYY 
(YY 
intYY 
imageIdYY  
inYY! #
	imagesIdsYY$ -
)YY- .
{ZZ 
await[[ 
_imagesHandler[[ $
.[[$ %
RemoveImageAsync[[% 5
([[5 6
imageId[[6 =
)[[= >
;[[> ?
}\\ 
Data__ 
.__ 
Models__ 
.__ 
Console__ 
console__  '
=__( )
await__* /
_context__0 8
.__8 9
Consoles__9 A
.__A B
Where__B G
(__G H
x__H I
=>__J L
x__M N
.__N O
Id__O Q
==__R T
id__U W
)__W X
.__X Y

FirstAsync__Y c
(__c d
)__d e
;__e f
_context`` 
.`` 
Consoles`` 
.`` 
Remove`` $
(``$ %
console``% ,
)``, -
;``- .
awaitaa 
_contextaa 
.aa 
SaveChangesAsyncaa +
(aa+ ,
)aa, -
;aa- .
returncc 
;cc 
}dd 	
publicee 
boolee 
	CanDeleteee 
(ee 
intee !
idee" $
)ee$ %
{ff 	
returngg 
!gg 
_contextgg 
.gg 
UserConsolesgg )
.gg) *
Wheregg* /
(gg/ 0
xgg0 1
=>gg2 4
xgg5 6
.gg6 7
	ConsoleIdgg7 @
==ggA C
idggD F
)ggF G
.ggG H
AnyggH K
(ggK L
)ggL M
;ggM N
}hh 	
}ii 
}jj —l
l/home/karolis/Github/Univeras/7-semestras/Program≈≥ Sistem≈≥ Testavimas/PST/Backend/Handlers/FilesHandler.cs
	namespace 	
Backend
 
. 
Handlers 
{ 
public 

class 
FilesHandler 
{ 
private 
readonly 
AppDbContext %
_context& .
;. /
private 
readonly 
IMapper  
_mapper! (
;( )
private 
readonly 
IOptions !
<! "
CloudinaryConfig" 2
>2 3
_config4 ;
;; <
private 
readonly 

Cloudinary #
_cloudinary$ /
;/ 0
private 
readonly 
bool 
_disableCloudinary 0
;0 1
public 
FilesHandler 
( 
AppDbContext (
context) 0
,0 1
IMapper2 9
mapper: @
,@ A
IOptionsB J
<J K
CloudinaryConfigK [
>[ \
config] c
,c d
boole i
disableCloudinaryj {
=| }
false	~ É
)
É Ñ
{ 	
_context 
= 
context 
; 
_mapper 
= 
mapper 
; 
_config 
= 
config 
; 
_cloudinary 
= 
new 

Cloudinary (
(( )
new) ,
Account- 4
(4 5
_config5 <
.< =
Value= B
.B C
CloudC H
,H I
_configJ Q
.Q R
ValueR W
.W X
ApiKeyX ^
,^ _
_config` g
.g h
Valueh m
.m n
	ApiSecretn w
)w x
)x y
;y z
_disableCloudinary 
=  
disableCloudinary! 2
;2 3
} 	
public 
async 
Task 
< 
List 
< 
ImageGetDto *
>* +
>+ ,!
GetConsoleImagesAsync- B
(B C
intC F
	consoleIdG P
)P Q
{   	
return!! 
_mapper!! 
.!! 
Map!! 
<!! 
List!! #
<!!# $
Image!!$ )
>!!) *
,!!* +
List!!, 0
<!!0 1
ImageGetDto!!1 <
>!!< =
>!!= >
(!!> ?
_context!!? G
.!!G H
Consoles!!H P
.!!P Q
Include!!Q X
(!!X Y
x!!Y Z
=>!![ ]
x!!^ _
.!!_ `
Images!!` f
)!!f g
.!!g h
Where!!h m
(!!m n
x!!n o
=>!!p r
x!!s t
.!!t u
Id!!u w
==!!x z
	consoleId	!!{ Ñ
)
!!Ñ Ö
.
!!Ö Ü
First
!!Ü ã
(
!!ã å
)
!!å ç
.
!!ç é
Images
!!é î
.
!!î ï
ToList
!!ï õ
(
!!õ ú
)
!!ú ù
)
!!ù û
;
!!û ü
}"" 	
public## 
async## 
Task## 
<## 
List## 
<## 
ImageGetDto## *
>##* +
>##+ ,%
GetUserConsoleImagesAsync##- F
(##F G
int##G J
	consoleId##K T
)##T U
{$$ 	
return%% 
_mapper%% 
.%% 
Map%% 
<%% 
List%% #
<%%# $
Image%%$ )
>%%) *
,%%* +
List%%, 0
<%%0 1
ImageGetDto%%1 <
>%%< =
>%%= >
(%%> ?
_context%%? G
.%%G H
UserConsoles%%H T
.%%T U
Include%%U \
(%%\ ]
x%%] ^
=>%%_ a
x%%b c
.%%c d
Images%%d j
)%%j k
.%%k l
Where%%l q
(%%q r
x%%r s
=>%%t v
x%%w x
.%%x y
Id%%y {
==%%| ~
	consoleId	%% à
)
%%à â
.
%%â ä
First
%%ä è
(
%%è ê
)
%%ê ë
.
%%ë í
Images
%%í ò
.
%%ò ô
ToList
%%ô ü
(
%%ü †
)
%%† °
)
%%° ¢
;
%%¢ £
}&& 	
public'' 
async'' 
Task'' 
<'' 
ImageGetDto'' %
>''% &
GetImageAsync''' 4
(''4 5
int''5 8
id''9 ;
)''; <
{(( 	
return)) 
_mapper)) 
.)) 
Map)) 
<)) 
Image)) $
,))$ %
ImageGetDto))& 1
>))1 2
())2 3
_context))3 ;
.)); <
Images))< B
.))B C
Where))C H
())H I
x))I J
=>))K M
x))N O
.))O P
Id))P R
==))S U
id))V X
)))X Y
.))Y Z
First))Z _
())_ `
)))` a
)))a b
;))b c
}** 	
public++ 
async++ 
Task++ 
AddImageAsync++ '
(++' (
ImageAddDto++( 3
imageDto++4 <
)++< =
{,, 	
byte.. 
[.. 
].. 
bytes.. 
=.. 
Convert.. "
..." #
FromBase64String..# 3
(..3 4
imageDto..4 <
...< =
Stream..= C
)..C D
;..D E
var00 
stream00 
=00 
new00 
MemoryStream00 )
(00) *
bytes00* /
)00/ 0
;000 1
var33 
uploadParams33 
=33 
new33 "
ImageUploadParams33# 4
(334 5
)335 6
{44 
File55 
=55 
new55 
FileDescription55 *
(55* +
$str55+ 5
,555 6
stream557 =
)55= >
}66 
;66 
ImageUploadResult77 
uploadResult77 *
;77* +
if88 
(88 
!88 
_disableCloudinary88 #
)88# $
{99 
uploadResult:: 
=:: 
_cloudinary:: *
.::* +
Upload::+ 1
(::1 2
uploadParams::2 >
)::> ?
;::? @
};; 
else<< 
if<< 
(<< 
true<< 
)<< 
{== 
uploadResult>> 
=>> 
new>> "
ImageUploadResult>># 4
(>>4 5
)>>5 6
{>>7 8
PublicId>>9 A
=>>B C
$str>>D M
}>>N O
;>>O P
}?? 
ImageDD 
imageDD 
;DD 
ifFF 
(FF 
imageDtoFF 
.FF 
	ConsoleIdFF "
!=FF# %
nullFF& *
)FF* +
{GG 
imageHH 
=HH 
newHH 
ImageHH !
{HH" #
NameHH$ (
=HH) *
imageDtoHH+ 3
.HH3 4
NameHH4 8
,HH8 9
PathHH: >
=HH? @
uploadResultHHA M
.HHM N
PublicIdHHN V
,HHV W
DescriptionHHX c
=HHd e
imageDtoHHf n
.HHn o
DescriptionHHo z
,HHz {
	ConsoleId	HH| Ö
=
HHÜ á
imageDto
HHà ê
.
HHê ë
	ConsoleId
HHë ö
}
HHõ ú
;
HHú ù
}II 
elseJJ 
{KK 
imageLL 
=LL 
newLL 
ImageLL !
{LL" #
NameLL$ (
=LL) *
imageDtoLL+ 3
.LL3 4
NameLL4 8
,LL8 9
PathLL: >
=LL? @
uploadResultLLA M
.LLM N
PublicIdLLN V
,LLV W
DescriptionLLX c
=LLd e
imageDtoLLf n
.LLn o
DescriptionLLo z
,LLz {
UserConsoleId	LL| â
=
LLä ã
imageDto
LLå î
.
LLî ï
UserConsoleId
LLï ¢
}
LL£ §
;
LL§ •
}NN 
imagePP 
.PP 
PathPP 
=PP 
uploadResultPP %
.PP% &
PublicIdPP& .
;PP. /
_contextRR 
.RR 
ImagesRR 
.RR 
AddRR 
(RR  
imageRR  %
)RR% &
;RR& '
awaitSS 
_contextSS 
.SS 
SaveChangesAsyncSS +
(SS+ ,
)SS, -
;SS- .
returnUU 
;UU 
}VV 	
publicWW 
asyncWW 
TaskWW 
<WW 
ImageGetDtoWW %
>WW% &
UpdateImageAsyncWW' 7
(WW7 8
ImageUpdateDtoWW8 F
imageDtoWWG O
)WWO P
{XX 	
ImageZZ 
imageZZ 
=ZZ 
_contextZZ "
.ZZ" #
ImagesZZ# )
.ZZ) *
WhereZZ* /
(ZZ/ 0
xZZ0 1
=>ZZ2 4
xZZ5 6
.ZZ6 7
IdZZ7 9
==ZZ: <
imageDtoZZ= E
.ZZE F
IdZZF H
)ZZH I
.ZZI J
FirstZZJ O
(ZZO P
)ZZP Q
;ZZQ R
image[[ 
.[[ 
Description[[ 
=[[ 
imageDto[[  (
.[[( )
Description[[) 4
;[[4 5
image\\ 
.\\ 
Name\\ 
=\\ 
imageDto\\ !
.\\! "
Name\\" &
;\\& '
_context]] 
.]] 
Images]] 
.]] 
Update]] "
(]]" #
image]]# (
)]]( )
;]]) *
await^^ 
_context^^ 
.^^ 
SaveChangesAsync^^ +
(^^+ ,
)^^, -
;^^- .
return`` 
_mapper`` 
.`` 
Map`` 
<`` 
Image`` $
,``$ %
ImageGetDto``& 1
>``1 2
(``2 3
image``3 8
)``8 9
;``9 :
}aa 	
publicbb 
asyncbb 
Taskbb 
<bb 
ImageGetDtobb %
>bb% &
RemoveImageAsyncbb' 7
(bb7 8
intbb8 ;
idbb< >
)bb> ?
{cc 	
Imagedd 
imagedd 
=dd 
_contextdd "
.dd" #
Imagesdd# )
.dd) *
Wheredd* /
(dd/ 0
xdd0 1
=>dd2 4
xdd5 6
.dd6 7
Iddd7 9
==dd: <
iddd= ?
)dd? @
.dd@ A
FirstddA F
(ddF G
)ddG H
;ddH I
_contextii 
.ii 
Imagesii 
.ii 
Removeii "
(ii" #
imageii# (
)ii( )
;ii) *
awaitjj 
_contextjj 
.jj 
SaveChangesAsyncjj +
(jj+ ,
)jj, -
;jj- .
returnkk 
_mapperkk 
.kk 
Mapkk 
<kk 
Imagekk $
,kk$ %
ImageGetDtokk& 1
>kk1 2
(kk2 3
imagekk3 8
)kk8 9
;kk9 :
}ll 	
publicnn 
asyncnn 
Tasknn 
AddMessageFileAsyncnn -
(nn- .
MessageFileAddDtonn. ?
fileDtonn@ G
)nnG H
{oo 	
byteqq 
[qq 
]qq 
bytesqq 
=qq 
Convertqq "
.qq" #
FromBase64Stringqq# 3
(qq3 4
fileDtoqq4 ;
.qq; <
Streamqq< B
)qqB C
;qqC D
varss 
streamss 
=ss 
newss 
MemoryStreamss )
(ss) *
bytesss* /
)ss/ 0
;ss0 1
varvv 
uploadParamsvv 
=vv 
newvv "
ImageUploadParamsvv# 4
(vv4 5
)vv5 6
{ww 
Filexx 
=xx 
newxx 
FileDescriptionxx *
(xx* +
$strxx+ 5
,xx5 6
streamxx7 =
)xx= >
}yy 
;yy 
ImageUploadResultzz 
uploadResultzz *
;zz* +
if{{ 
({{ 
!{{ 
_disableCloudinary{{ #
){{# $
{|| 
uploadResult}} 
=}} 
_cloudinary}} *
.}}* +
Upload}}+ 1
(}}1 2
uploadParams}}2 >
)}}> ?
;}}? @
}~~ 
else 
{
ÄÄ 
uploadResult
ÅÅ 
=
ÅÅ 
new
ÅÅ "
ImageUploadResult
ÅÅ# 4
(
ÅÅ4 5
)
ÅÅ5 6
{
ÅÅ7 8
PublicId
ÅÅ9 A
=
ÅÅB C
$str
ÅÅD M
}
ÅÅN O
;
ÅÅO P
}
ÇÇ 
MessageFile
ÜÜ 
file
ÜÜ 
=
ÜÜ 
new
ÜÜ "
MessageFile
ÜÜ# .
{
ÜÜ/ 0
Name
ÜÜ1 5
=
ÜÜ6 7
fileDto
ÜÜ8 ?
.
ÜÜ? @
Name
ÜÜ@ D
,
ÜÜD E
Path
ÜÜF J
=
ÜÜK L
uploadResult
ÜÜM Y
.
ÜÜY Z
PublicId
ÜÜZ b
,
ÜÜb c
Description
ÜÜd o
=
ÜÜp q
fileDto
ÜÜr y
.
ÜÜy z
DescriptionÜÜz Ö
,ÜÜÖ Ü
	MessageIdÜÜá ê
=ÜÜë í
fileDtoÜÜì ö
.ÜÜö õ
	MessageIdÜÜõ §
}ÜÜ• ¶
;ÜÜ¶ ß
_context
àà 
.
àà 
MessageFiles
àà !
.
àà! "
Add
àà" %
(
àà% &
file
àà& *
)
àà* +
;
àà+ ,
await
ââ 
_context
ââ 
.
ââ 
SaveChangesAsync
ââ +
(
ââ+ ,
)
ââ, -
;
ââ- .
return
ãã 
;
ãã 
}
åå 	
}
çç 
}éé §ü
s/home/karolis/Github/Univeras/7-semestras/Program≈≥ Sistem≈≥ Testavimas/PST/Backend/Handlers/UserConsolesHandler.cs
	namespace 	
Backend
 
. 
Handlers 
{ 
public 

class 
UserConsolesHandler $
{ 
private 
readonly 
IMapper  
_mapper! (
;( )
private 
readonly 
FilesHandler %
_imagesHandler& 4
;4 5
private 
readonly 
AppDbContext %
_context& .
;. /
private 
readonly 
UserManager $
<$ %
User% )
>) *
_userManager+ 7
;7 8
public 
UserConsolesHandler "
(" #
IMapper# *
mapper+ 1
,1 2
FilesHandler3 ?
imagesHandler@ M
,M N
AppDbContextO [
context\ c
,c d
UserManagere p
<p q
Userq u
>u v
userManager	w Ç
)
Ç É
{ 	
_mapper 
= 
mapper 
; 
_imagesHandler 
= 
imagesHandler *
;* +
_context 
= 
context 
; 
_userManager 
= 
userManager &
;& '
} 	
public 
async 
Task 
< 
List 
< 
UserConsoleGetDto 0
>0 1
>1 2 
GetUserConsolesAsync3 G
(G H
ClaimsPrincipalH W
claimsX ^
)^ _
{ 	
User 
user 
= 
await 
_userManager *
.* +
GetUserAsync+ 7
(7 8
claims8 >
)> ?
;? @
return 
_mapper 
. 
Map 
< 
List #
<# $
UserConsole$ /
>/ 0
,0 1
List2 6
<6 7
UserConsoleGetDto7 H
>H I
>I J
(J K
_contextK S
.S T
UserConsolesT `
.` a
Includea h
(h i
xi j
=>k m
xn o
.o p
Imagesp v
)v w
.w x
Includex 
(	 Ä
x
Ä Å
=>
Ç Ñ
x
Ö Ü
.
Ü á
Console
á é
)
é è
.
è ê
Include
ê ó
(
ó ò
x
ò ô
=>
ö ú
x
ù û
.
û ü
Conversation
ü ´
)
´ ¨
.
¨ ≠
Where
≠ ≤
(
≤ ≥
x
≥ ¥
=>
µ ∑
x
∏ π
.
π ∫
UserId
∫ ¿
==
¡ √
user
ƒ »
.
» …
Id
… À
)
À Ã
.
Ã Õ
ToList
Õ ”
(
” ‘
)
‘ ’
)
’ ÷
;
÷ ◊
}   	
public!! 
async!! 
Task!! 
<!! 
List!! 
<!! 
UserConsoleGetDto!! 0
>!!0 1
>!!1 2(
GetUserConsolesByStatusAsync!!3 O
(!!O P
ClaimsPrincipal!!P _
claims!!` f
,!!f g
UserConsoleStatus!!h y
status	!!z Ä
)
!!Ä Å
{"" 	
User## 
user## 
=## 
await## 
_userManager## *
.##* +
GetUserAsync##+ 7
(##7 8
claims##8 >
)##> ?
;##? @
return$$ 
_mapper$$ 
.$$ 
Map$$ 
<$$ 
List$$ #
<$$# $
UserConsole$$$ /
>$$/ 0
,$$0 1
List$$2 6
<$$6 7
UserConsoleGetDto$$7 H
>$$H I
>$$I J
($$J K
_context$$K S
.$$S T
UserConsoles$$T `
.$$` a
Include$$a h
($$h i
x$$i j
=>$$k m
x$$n o
.$$o p
Images$$p v
)$$v w
.$$w x
Include$$x 
(	$$ Ä
x
$$Ä Å
=>
$$Ç Ñ
x
$$Ö Ü
.
$$Ü á
Console
$$á é
)
$$é è
.
$$è ê
Include
$$ê ó
(
$$ó ò
x
$$ò ô
=>
$$ö ú
x
$$ù û
.
$$û ü
Conversation
$$ü ´
)
$$´ ¨
.
$$¨ ≠
Where
$$≠ ≤
(
$$≤ ≥
x
$$≥ ¥
=>
$$µ ∑
x
$$∏ π
.
$$π ∫
ConsoleStatus
$$∫ «
==
$$»  
status
$$À —
)
$$— “
.
$$“ ”
ToList
$$” Ÿ
(
$$Ÿ ⁄
)
$$⁄ €
)
$$€ ‹
;
$$‹ ›
}%% 	
public&& 
async&& 
Task&& 
<&& 
UserConsoleGetDto&& +
>&&+ ,
GetUserConsoleAsync&&- @
(&&@ A
int&&A D
id&&E G
)&&G H
{'' 	
return(( 
_mapper(( 
.(( 
Map(( 
<(( 
UserConsole(( *
,((* +
UserConsoleGetDto((, =
>((= >
(((> ?
_context((? G
.((G H
UserConsoles((H T
.((T U
Include((U \
(((\ ]
x((] ^
=>((_ a
x((b c
.((c d
Images((d j
)((j k
.((k l
Include((l s
(((s t
x((t u
=>((v x
x((y z
.((z {
Console	(({ Ç
)
((Ç É
.
((É Ñ
Include
((Ñ ã
(
((ã å
x
((å ç
=>
((é ê
x
((ë í
.
((í ì
Conversation
((ì ü
)
((ü †
.
((† °
Include
((° ®
(
((® ©
x
((© ™
=>
((´ ≠
x
((Æ Ø
.
((Ø ∞
User
((∞ ¥
)
((¥ µ
.
((µ ∂
Where
((∂ ª
(
((ª º
x
((º Ω
=>
((æ ¿
x
((¡ ¬
.
((¬ √
Id
((√ ≈
==
((∆ »
id
((… À
)
((À Ã
.
((Ã Õ
First
((Õ “
(
((“ ”
)
((” ‘
)
((‘ ’
;
((’ ÷
})) 	
public** 
async** 
Task** 
<** 
UserConsoleGetDto** +
>**+ ,
AddUserConsoleAsync**- @
(**@ A
UserConsoleAddDto**A R
userConsoleDto**S a
,**a b
ClaimsPrincipal**c r
claims**s y
)**y z
{++ 	
var,, 
user,, 
=,, 
await,, 
_userManager,, )
.,,) *
GetUserAsync,,* 6
(,,6 7
claims,,7 =
),,= >
;,,> ?
List.. 
<.. 
ImageAddDto.. 
>.. 
images.. $
=..% &
userConsoleDto..' 5
...5 6
Images..6 <
...< =
ToList..= C
(..C D
)..D E
;..E F
UserConsole11 
userConsole11 #
=11$ %
_mapper11& -
.11- .
Map11. 1
<111 2
UserConsoleAddDto112 C
,11C D
UserConsole11E P
>11P Q
(11Q R
userConsoleDto11R `
)11` a
;11a b
userConsole22 
.22 
Images22 
=22  
null22! %
;22% &
userConsole33 
.33 
ConsoleStatus33 %
=33& '
UserConsoleStatus33( 9
.339 :
UNCONFIRMED33: E
;33E F
userConsole44 
.44 
UserId44 
=44  
user44! %
.44% &
Id44& (
;44( )
var55 
res55 
=55 
_context55 
.55 
UserConsoles55 +
.55+ ,
Add55, /
(55/ 0
userConsole550 ;
)55; <
;55< =
await66 
_context66 
.66 
SaveChangesAsync66 +
(66+ ,
)66, -
;66- .
for99 
(99 
int99 
i99 
=99 
$num99 
;99 
i99 
<99 
images99  &
.99& '
Count99' ,
;99, -
i99. /
++99/ 1
)991 2
{:: 
images;; 
[;; 
i;; 
];; 
.;; 
UserConsoleId;; '
=;;( )
res;;* -
.;;- .
Entity;;. 4
.;;4 5
Id;;5 7
;;;7 8
await<< 
_imagesHandler<< $
.<<$ %
AddImageAsync<<% 2
(<<2 3
images<<3 9
[<<9 :
i<<: ;
]<<; <
)<<< =
;<<= >
}== 
UserConsole?? 
result?? 
=??  
_context??! )
.??) *
UserConsoles??* 6
.??6 7
Include??7 >
(??> ?
x??? @
=>??A C
x??D E
.??E F
Images??F L
)??L M
.??M N
Where??N S
(??S T
x??T U
=>??V X
x??Y Z
.??Z [
Id??[ ]
==??^ `
res??a d
.??d e
Entity??e k
.??k l
Id??l n
)??n o
.??o p
First??p u
(??u v
)??v w
;??w x
return@@ 
_mapper@@ 
.@@ 
Map@@ 
<@@ 
UserConsole@@ *
,@@* +
UserConsoleGetDto@@, =
>@@= >
(@@> ?
result@@? E
)@@E F
;@@F G
}AA 	
publicCC 
asyncCC 
TaskCC 
<CC 
UserConsoleGetDtoCC +
>CC+ ,"
UpdateUserConsoleAsyncCC- C
(CCC D 
UserConsoleUpdateDtoCCD X
userConsoleDtoCCY g
)CCg h
{DD 	
ListFF 
<FF 
ImageUpdateDtoFF 
>FF  
imagesFF! '
=FF( )
userConsoleDtoFF* 8
.FF8 9
ImagesFF9 ?
.FF? @
ToListFF@ F
(FFF G
)FFG H
;FFH I
foreachGG 
(GG 
ImageUpdateDtoGG #
imageGG$ )
inGG* ,
imagesGG- 3
)GG3 4
{HH 
awaitII 
_imagesHandlerII $
.II$ %
UpdateImageAsyncII% 5
(II5 6
imageII6 ;
)II; <
;II< =
}JJ 
UserConsoleMM 
changesMM 
=MM  !
_mapperMM" )
.MM) *
MapMM* -
<MM- . 
UserConsoleUpdateDtoMM. B
,MMB C
UserConsoleMMD O
>MMO P
(MMP Q
userConsoleDtoMMQ _
)MM_ `
;MM` a
UserConsoleOO 
originalOO  
=OO! "
_contextOO# +
.OO+ ,
UserConsolesOO, 8
.OO8 9
WhereOO9 >
(OO> ?
xOO? @
=>OOA C
xOOD E
.OOE F
IdOOF H
==OOI K
userConsoleDtoOOL Z
.OOZ [
IdOO[ ]
)OO] ^
.OO^ _
FirstOO_ d
(OOd e
)OOe f
;OOf g
foreachPP 
(PP 
PropertyInfoPP !
infoPP" &
inPP' )
originalPP* 2
.PP2 3
GetTypePP3 :
(PP: ;
)PP; <
.PP< =
GetPropertiesPP= J
(PPJ K
)PPK L
)PPL M
{QQ 
ifRR 
(RR 
infoRR 
.RR 
GetValueRR !
(RR! "
changesRR" )
)RR) *
==RR+ -
nullRR. 2
||RR3 5
infoRR6 :
.RR: ;
NameRR; ?
==RR@ B
$strRRC G
)RRG H
{SS 
continueTT 
;TT 
}UU 
infoVV 
.VV 
SetValueVV 
(VV 
originalVV &
,VV& '
infoVV( ,
.VV, -
GetValueVV- 5
(VV5 6
changesVV6 =
)VV= >
)VV> ?
;VV? @
}WW 
_contextYY 
.YY 
UserConsolesYY !
.YY! "
UpdateYY" (
(YY( )
originalYY) 1
)YY1 2
;YY2 3
awaitZZ 
_contextZZ 
.ZZ 
SaveChangesAsyncZZ +
(ZZ+ ,
)ZZ, -
;ZZ- .
UserConsole\\ 
result\\ 
=\\  
_context\\! )
.\\) *
UserConsoles\\* 6
.\\6 7
Include\\7 >
(\\> ?
x\\? @
=>\\A C
x\\D E
.\\E F
Images\\F L
)\\L M
.\\M N
Where\\N S
(\\S T
x\\T U
=>\\V X
x\\Y Z
.\\Z [
Id\\[ ]
==\\^ `
userConsoleDto\\a o
.\\o p
Id\\p r
)\\r s
.\\s t
First\\t y
(\\y z
)\\z {
;\\{ |
return]] 
_mapper]] 
.]] 
Map]] 
<]] 
UserConsole]] *
,]]* +
UserConsoleGetDto]], =
>]]= >
(]]> ?
result]]? E
)]]E F
;]]F G
}^^ 	
public`` 
async`` 
Task`` "
RemoveUserConsoleAsync`` 0
(``0 1
int``1 4
id``5 7
)``7 8
{aa 	
varcc 
conversationcc 
=cc 
awaitcc $
_contextcc% -
.cc- .
Conversationscc. ;
.cc; <
Wherecc< A
(ccA B
xccB C
=>ccD F
xccG H
.ccH I
UserConsoleIdccI V
==ccW Y
idccZ \
)cc\ ]
.cc] ^
FirstOrDefaultAsynccc^ q
(ccq r
)ccr s
;ccs t
ifdd 
(dd 
conversationdd 
!=dd 
nulldd  $
)dd$ %
{ee 
_contextff 
.ff 
Conversationsff &
.ff& '
Removeff' -
(ff- .
conversationff. :
)ff: ;
;ff; <
}gg 
Listjj 
<jj 
intjj 
>jj 
	imagesIdsjj 
=jj  !
(jj" #
awaitjj# (
_imagesHandlerjj) 7
.jj7 8%
GetUserConsoleImagesAsyncjj8 Q
(jjQ R
idjjR T
)jjT U
)jjU V
.jjV W
SelectjjW ]
(jj] ^
xjj^ _
=>jj` b
xjjc d
.jjd e
Idjje g
)jjg h
.jjh i
ToListjji o
(jjo p
)jjp q
;jjq r
foreachkk 
(kk 
intkk 
imageIdkk  
inkk! #
	imagesIdskk$ -
)kk- .
{ll 
awaitmm 
_imagesHandlermm $
.mm$ %
RemoveImageAsyncmm% 5
(mm5 6
imageIdmm6 =
)mm= >
;mm> ?
}nn 
UserConsoleqq 
userConsoleqq #
=qq$ %
awaitqq& +
_contextqq, 4
.qq4 5
UserConsolesqq5 A
.qqA B
WhereqqB G
(qqG H
xqqH I
=>qqJ L
xqqM N
.qqN O
IdqqO Q
==qqR T
idqqU W
)qqW X
.qqX Y

FirstAsyncqqY c
(qqc d
)qqd e
;qqe f
ifss 
(ss 
userConsoless 
.ss 
ConsoleStatusss )
!=ss* ,
UserConsoleStatusss- >
.ss> ?
UNCONFIRMEDss? J
)ssJ K
{tt 
throwuu 
newuu %
InvalidOperationExceptionuu 3
(uu3 4
$struu4 6
)uu6 7
;uu7 8
}vv 
_contextxx 
.xx 
UserConsolesxx !
.xx! "
Removexx" (
(xx( )
userConsolexx) 4
)xx4 5
;xx5 6
awaityy 
_contextyy 
.yy 
SaveChangesAsyncyy +
(yy+ ,
)yy, -
;yy- .
returnzz 
;zz 
}{{ 	
public}} 
async}} 
Task}} 
UpdateStatus}} &
(}}& '&
UserConsoleStatusUpdateDto}}' A
status}}B H
,}}H I
ClaimsPrincipal}}J Y

userClaims}}Z d
)}}d e
{~~ 	
var 
user 
= 
await 
_userManager )
.) *
GetUserAsync* 6
(6 7

userClaims7 A
)A B
;B C
var
ÄÄ 
role
ÄÄ 
=
ÄÄ 
(
ÄÄ 
await
ÄÄ 
_userManager
ÄÄ *
.
ÄÄ* +
GetRolesAsync
ÄÄ+ 8
(
ÄÄ8 9
user
ÄÄ9 =
)
ÄÄ= >
)
ÄÄ> ?
.
ÄÄ? @
First
ÄÄ@ E
(
ÄÄE F
)
ÄÄF G
.
ÄÄG H
ToLower
ÄÄH O
(
ÄÄO P
)
ÄÄP Q
;
ÄÄQ R
UserConsoleStatus
ÇÇ 
consoleStatus
ÇÇ +
=
ÇÇ, -
status
ÇÇ. 4
.
ÇÇ4 5
ConsoleStatus
ÇÇ5 B
;
ÇÇB C
if
ÑÑ 
(
ÑÑ 
role
ÑÑ 
==
ÑÑ 
$str
ÑÑ 
&&
ÑÑ  "
(
ÖÖ 
consoleStatus
ÖÖ 
==
ÖÖ !
UserConsoleStatus
ÖÖ" 3
.
ÖÖ3 4
RESERVED
ÖÖ4 <
||
ÜÜ 
consoleStatus
ÜÜ  
==
ÜÜ! #
UserConsoleStatus
ÜÜ$ 5
.
ÜÜ5 6,
AWAITING_TERMINATION_BY_LENDER
ÜÜ6 T
||
áá 
consoleStatus
áá  
==
áá! #
UserConsoleStatus
áá$ 5
.
áá5 6.
 AWAITING_TERMINATION_BY_BORROWER
áá6 V
)
ááV W
)
ááW X
{
àà 
throw
ââ 
new
ââ 
	Exception
ââ #
(
ââ# $
$str
ââ$ 4
)
ââ4 5
;
ââ5 6
}
ää 
if
åå 
(
åå 
role
åå 
==
åå 
$str
åå  
&&
åå! #
consoleStatus
åå$ 1
!=
åå2 4
UserConsoleStatus
åå5 F
.
ååF G,
AWAITING_TERMINATION_BY_LENDER
ååG e
)
ååe f
{
çç 
throw
éé 
new
éé 
	Exception
éé #
(
éé# $
$str
éé$ 4
)
éé4 5
;
éé5 6
}
èè 
if
ëë 
(
ëë 
role
ëë 
==
ëë 
$str
ëë !
&&
ëë" $
consoleStatus
ëë% 2
!=
ëë3 5
UserConsoleStatus
ëë6 G
.
ëëG H.
 AWAITING_TERMINATION_BY_BORROWER
ëëH h
)
ëëh i
{
íí 
throw
ìì 
new
ìì 
	Exception
ìì #
(
ìì# $
$str
ìì$ 4
)
ìì4 5
;
ìì5 6
}
îî 
UserConsole
ññ 
userConsole
ññ #
=
ññ$ %
_context
ññ& .
.
ññ. /
UserConsoles
ññ/ ;
.
ññ; <
Where
ññ< A
(
ññA B
x
ññB C
=>
ññC E
x
ññE F
.
ññF G
Id
ññG I
==
ññJ L
status
ññM S
.
ññS T
Id
ññT V
)
ññV W
.
ññW X
First
ññX ]
(
ññ] ^
)
ññ^ _
;
ññ_ `
userConsole
óó 
.
óó 
ConsoleStatus
óó %
=
óó& '
status
óó( .
.
óó. /
ConsoleStatus
óó/ <
;
óó< =
if
òò 
(
òò 
status
òò 
.
òò 
ConsoleStatus
òò #
==
òò$ &
UserConsoleStatus
òò' 8
.
òò8 9
UNCONFIRMED
òò9 D
||
òòE G
status
òòH N
.
òòN O
ConsoleStatus
òòO \
==
òò] _
UserConsoleStatus
òò` q
.
òòq r
AT_PLATFORM
òòr }
)
òò} ~
{
ôô 
userConsole
öö 
.
öö 
BorrowingId
öö '
=
öö( )
null
öö* .
;
öö. /
}
õõ 
_context
úú 
.
úú 
UserConsoles
úú !
.
úú! "
Update
úú" (
(
úú( )
userConsole
úú) 4
)
úú4 5
;
úú5 6
await
ùù 
_context
ùù 
.
ùù 
SaveChangesAsync
ùù +
(
ùù+ ,
)
ùù, -
;
ùù- .
return
ûû 
;
ûû 
}
üü 	
}
†† 
}°° ıŒ
l/home/karolis/Github/Univeras/7-semestras/Program≈≥ Sistem≈≥ Testavimas/PST/Backend/Handlers/UsersHandler.cs
	namespace 	
Backend
 
. 
Handlers 
{ 
public 

class 
UsersHandler 
{ 
private 
readonly 
UserManager $
<$ %
User% )
>) *
_userManager+ 7
;7 8
private 
readonly 
AppDbContext %
_context& .
;. /
private 
readonly 
IOptions !
<! "

SmtpConfig" ,
>, -
_config. 5
;5 6
public 
UsersHandler 
( 
UserManager '
<' (
User( ,
>, -
userManager. 9
,9 :
AppDbContext; G
contextH O
,O P
IOptionsQ Y
<Y Z

SmtpConfigZ d
>d e
configf l
)l m
{ 	
_userManager 
= 
userManager &
;& '
_context 
= 
context 
; 
_config 
= 
config 
; 
} 	
public 
async 
Task 
< 
List 
< 
User #
># $
>$ %
GetUsers& .
(. /
string/ 5
?5 6
roleName7 ?
)? @
{ 	
if 
( 
roleName 
== 
null  
)  !
{ 
return 
_userManager #
.# $
Users$ )
.) *
Select* 0
(0 1
x1 2
=>3 5
x6 7
)7 8
.8 9
ToList9 ?
(? @
)@ A
;A B
}   
return!! 
(!! 
await!! 
_userManager!! &
.!!& '
GetUsersInRoleAsync!!' :
(!!: ;
roleName!!; C
)!!C D
)!!D E
.!!E F
ToList!!F L
(!!L M
)!!M N
;!!N O
}"" 	
public$$ 
async$$ 
Task$$ 
<$$ 
MailMessage$$ %
>$$% &%
GenerateConfirmationEmail$$' @
($$@ A
User$$A E
user$$F J
)$$J K
{%% 	"
EmailConfirmationToken&& "
?&&" #
token&&$ )
=&&* +
await&&, 1
_context&&2 :
.&&: ;#
EmailConfirmationTokens&&; R
.&&R S
Where&&S X
(&&X Y
x&&Y Z
=>&&[ ]
x&&^ _
.&&_ `
UserId&&` f
==&&g i
user&&j n
.&&n o
Id&&o q
)&&q r
.&&r s 
FirstOrDefaultAsync	&&s Ü
(
&&Ü á
)
&&á à
;
&&à â
if'' 
('' 
token'' 
!='' 
null'' 
)'' 
{(( 
_context)) 
.)) #
EmailConfirmationTokens)) 0
.))0 1
Remove))1 7
())7 8
token))8 =
)))= >
;))> ?
}** 
var++ 
item++ 
=++ 
_context++ 
.++  #
EmailConfirmationTokens++  7
.++7 8
Add++8 ;
(++; <
new++< ?"
EmailConfirmationToken++@ V
{++W X
UserId++Y _
=++` a
user++b f
.++f g
Id++g i
,++i j
Token++k p
=++q r
await++s x
_userManager	++y Ö
.
++Ö Ü1
#GenerateEmailConfirmationTokenAsync
++Ü ©
(
++© ™
user
++™ Æ
)
++Æ Ø
}
++∞ ±
)
++± ≤
;
++≤ ≥
await,, 
_context,, 
.,, 
SaveChangesAsync,, +
(,,+ ,
),,, -
;,,- .
token-- 
=-- 
await-- 
_context-- "
.--" ##
EmailConfirmationTokens--# :
.--: ;
Where--; @
(--@ A
x--A B
=>--C E
x--F G
.--G H
UserId--H N
==--O Q
user--R V
.--V W
Id--W Y
)--Y Z
.--Z [

FirstAsync--[ e
(--e f
)--f g
;--g h
var// 
mailMessage// 
=// 
new// !
MailMessage//" -
{00 
From11 
=11 
new11 
MailAddress11 &
(11& '
_config11' .
.11. /
Value11/ 4
.114 5
Username115 =
)11= >
,11> ?
Subject22 
=22 
$str22 0
,220 1
Body33 
=33 
$"33 
$str	33 ®
{
33® ©
token
33© Æ
.
33Æ Ø
Token
33Ø ¥
.
33¥ µ
Replace
33µ º
(
33º Ω
$char
33Ω ¿
,
33¿ ¡
$char
33¬ ≈
)
33≈ ∆
}
33∆ «
$str
33« Õ
"
33Õ Œ
,
33Œ œ

IsBodyHtml44 
=44 
true44 !
,44! "
}55 
;55 
mailMessage66 
.66 
To66 
.66 
Add66 
(66 
_config66 &
.66& '
Value66' ,
.66, -
	TestEmail66- 6
)666 7
;667 8
return88 
mailMessage88 
;88 
}99 	
public;; 
async;; 
Task;; 
ConfirmEmail;; &
(;;& '
string;;' -
confirmationCode;;. >
);;> ?
{<< 	"
EmailConfirmationToken== "
?==" #"
emailConfirmationToken==$ :
===; <
await=== B
_context==C K
.==K L#
EmailConfirmationTokens==L c
.==c d
Where==d i
(==i j
x==j k
=>==l n
x==o p
.==p q
Token==q v
====w y
confirmationCode	==z ä
)
==ä ã
.
==ã å!
FirstOrDefaultAsync
==å ü
(
==ü †
)
==† °
;
==° ¢
if>> 
(>> "
emailConfirmationToken>> &
==>>' )
null>>* .
)>>. /
{?? 
throw@@ 
new@@ 
	Exception@@ #
(@@# $
$str@@$ S
)@@S T
;@@T U
}AA 
UserBB 
userBB 
=BB 
awaitBB 
_contextBB &
.BB& '
UsersBB' ,
.BB, -
WhereBB- 2
(BB2 3
xBB3 4
=>BB5 7
xBB8 9
.BB9 :
IdBB: <
==BB= ?"
emailConfirmationTokenBB@ V
.BBV W
UserIdBBW ]
)BB] ^
.BB^ _

FirstAsyncBB_ i
(BBi j
)BBj k
;BBk l
awaitCC 
_userManagerCC 
.CC 
ConfirmEmailAsyncCC 0
(CC0 1
userCC1 5
,CC5 6
confirmationCodeCC7 G
)CCG H
;CCH I
_contextDD 
.DD #
EmailConfirmationTokensDD ,
.DD, -
RemoveDD- 3
(DD3 4"
emailConfirmationTokenDD4 J
)DDJ K
;DDK L
awaitEE 
_contextEE 
.EE 
SaveChangesAsyncEE +
(EE+ ,
)EE, -
;EE- .
}FF 	
publicHH 
asyncHH 
TaskHH 
<HH 
MailMessageHH %
>HH% &&
GeneratePasswordResetEmailHH' A
(HHA B
stringHHB H
emailHHI N
)HHN O
{II 	
UserJJ 
userJJ 
=JJ 
awaitJJ 
_userManagerJJ *
.JJ* +
FindByEmailAsyncJJ+ ;
(JJ; <
emailJJ< A
.JJA B
ToUpperJJB I
(JJI J
)JJJ K
)JJK L
;JJL M
ifKK 
(KK 
userKK 
==KK 
nullKK 
)KK 
{LL 
throwNN 
newNN 
	ExceptionNN #
(NN# $
$strNN$ G
)NNG H
;NNH I
}OO 
PasswordResetTokenPP 
?PP 
tokenPP  %
=PP& '
awaitPP( -
_contextPP. 6
.PP6 7
PasswordResetTokensPP7 J
.PPJ K
WherePPK P
(PPP Q
xPPQ R
=>PPS U
xPPV W
.PPW X
UserIdPPX ^
==PP_ a
userPPb f
.PPf g
IdPPg i
)PPi j
.PPj k
FirstOrDefaultAsyncPPk ~
(PP~ 
)	PP Ä
;
PPÄ Å
ifQQ 
(QQ 
tokenQQ 
!=QQ 
nullQQ 
)QQ 
{RR 
_contextSS 
.SS 
PasswordResetTokensSS ,
.SS, -
RemoveSS- 3
(SS3 4
tokenSS4 9
)SS9 :
;SS: ;
}TT 
_contextUU 
.UU 
PasswordResetTokensUU (
.UU( )
AddUU) ,
(UU, -
newUU- 0
PasswordResetTokenUU1 C
{UUD E
UserIdUUF L
=UUM N
userUUO S
.UUS T
IdUUT V
,UUV W
TokenUUX ]
=UU^ _
awaitUU` e
_userManagerUUf r
.UUr s,
GeneratePasswordResetTokenAsync	UUs í
(
UUí ì
user
UUì ó
)
UUó ò
}
UUô ö
)
UUö õ
;
UUõ ú
awaitVV 
_contextVV 
.VV 
SaveChangesAsyncVV +
(VV+ ,
)VV, -
;VV- .
tokenWW 
=WW 
awaitWW 
_contextWW "
.WW" #
PasswordResetTokensWW# 6
.WW6 7
WhereWW7 <
(WW< =
xWW= >
=>WW? A
xWWB C
.WWC D
UserIdWWD J
==WWK M
userWWN R
.WWR S
IdWWS U
)WWU V
.WWV W

FirstAsyncWWW a
(WWa b
)WWb c
;WWc d
varYY 
mailMessageYY 
=YY 
newYY !
MailMessageYY" -
{ZZ 
From[[ 
=[[ 
new[[ 
MailAddress[[ &
([[& '
_config[[' .
.[[. /
Value[[/ 4
.[[4 5
Username[[5 =
)[[= >
,[[> ?
Subject\\ 
=\\ 
$str\\ *
,\\* +
Body]] 
=]] 
$"]] 
$str	]] ´
{
]]´ ¨
token
]]¨ ±
.
]]± ≤
Token
]]≤ ∑
.
]]∑ ∏
Replace
]]∏ ø
(
]]ø ¿
$char
]]¿ √
,
]]√ ƒ
$char
]]≈ »
)
]]» …
}
]]…  
$str
]]  –
"
]]– —
,
]]— “

IsBodyHtml^^ 
=^^ 
true^^ !
,^^! "
}__ 
;__ 
mailMessage`` 
.`` 
To`` 
.`` 
Add`` 
(`` 
_config`` &
.``& '
Value``' ,
.``, -
	TestEmail``- 6
)``6 7
;``7 8
returnaa 
mailMessageaa 
;aa 
}bb 	
publicdd 
asyncdd 
Taskdd 
ResetPassworddd '
(dd' (
stringdd( .
	resetCodedd/ 8
,dd8 9
stringdd: @
newPasswordddA L
)ddL M
{ee 	
PasswordResetTokenff 
?ff 
tokenff  %
=ff& '
awaitff( -
_contextff. 6
.ff6 7
PasswordResetTokensff7 J
.ffJ K
WhereffK P
(ffP Q
xffQ R
=>ffS U
xffV W
.ffW X
TokenffX ]
==ff^ `
	resetCodeffa j
)ffj k
.ffk l
FirstOrDefaultAsyncffl 
(	ff Ä
)
ffÄ Å
;
ffÅ Ç
ifgg 
(gg 
tokengg 
==gg 
nullgg 
)gg 
{hh 
throwii 
newii 
	Exceptionii #
(ii# $
$strii$ T
)iiT U
;iiU V
}jj 
Userkk 
userkk 
=kk 
awaitkk 
_userManagerkk *
.kk* +
FindByIdAsynckk+ 8
(kk8 9
tokenkk9 >
.kk> ?
UserIdkk? E
.kkE F
ToStringkkF N
(kkN O
)kkO P
)kkP Q
;kkQ R
awaitll 
_userManagerll 
.ll 
ResetPasswordAsyncll 1
(ll1 2
userll2 6
,ll6 7
	resetCodell8 A
,llA B
newPasswordllC N
)llN O
;llO P
_contextmm 
.mm 
Removemm 
(mm 
tokenmm !
)mm! "
;mm" #
awaitnn 
_contextnn 
.nn 
SaveChangesAsyncnn +
(nn+ ,
)nn, -
;nn- .
}oo 	
publicqq 
asyncqq 
Taskqq 
UpdatePhysicalqq (
(qq( )
ClaimsPrincipalqq) 8

userClaimsqq9 C
,qqC D
UserPhysicalUpdateqqE W
dataqqX \
)qq\ ]
{rr 	
Userss 
originalss 
=ss 
awaitss !
_userManagerss" .
.ss. /
GetUserAsyncss/ ;
(ss; <

userClaimsss< F
)ssF G
;ssG H
originaltt 
.tt 
	FirstNamett 
=tt  
datatt! %
.tt% &
	FirstNamett& /
;tt/ 0
originaluu 
.uu 
LastNameuu 
=uu 
datauu  $
.uu$ %
LastNameuu% -
;uu- .
_contextvv 
.vv 
Usersvv 
.vv 
Updatevv !
(vv! "
originalvv" *
)vv* +
;vv+ ,
awaitww 
_contextww 
.ww 
SaveChangesAsyncww +
(ww+ ,
)ww, -
;ww- .
returnxx 
;xx 
}yy 	
public{{ 
async{{ 
Task{{ 
UpdateLegal{{ %
({{% &
ClaimsPrincipal{{& 5

userClaims{{6 @
,{{@ A
UserLegalUpdate{{B Q
data{{R V
){{V W
{|| 	
User}} 
original}} 
=}} 
await}} !
_userManager}}" .
.}}. /
GetUserAsync}}/ ;
(}}; <

userClaims}}< F
)}}F G
;}}G H
original~~ 
.~~ 
CompanyCode~~  
=~~! "
data~~# '
.~~' (
CompanyCode~~( 3
;~~3 4
original 
. 
CompanyName  
=! "
data# '
.' (
CompanyName( 3
;3 4
_context
ÄÄ 
.
ÄÄ 
Users
ÄÄ 
.
ÄÄ 
Update
ÄÄ !
(
ÄÄ! "
original
ÄÄ" *
)
ÄÄ* +
;
ÄÄ+ ,
await
ÅÅ 
_context
ÅÅ 
.
ÅÅ 
SaveChangesAsync
ÅÅ +
(
ÅÅ+ ,
)
ÅÅ, -
;
ÅÅ- .
return
ÇÇ 
;
ÇÇ 
}
ÉÉ 	
public
ÖÖ 
async
ÖÖ 
Task
ÖÖ 
UpdateAddress
ÖÖ '
(
ÖÖ' (
ClaimsPrincipal
ÖÖ( 7

userClaims
ÖÖ8 B
,
ÖÖB C
UserAddressUpdate
ÖÖD U
data
ÖÖV Z
)
ÖÖZ [
{
ÜÜ 	
User
áá 
original
áá 
=
áá 
await
áá !
_userManager
áá" .
.
áá. /
GetUserAsync
áá/ ;
(
áá; <

userClaims
áá< F
)
ááF G
;
ááG H
original
àà 
.
àà 
Country
àà 
=
àà 
data
àà #
.
àà# $
Country
àà$ +
;
àà+ ,
original
ââ 
.
ââ 
County
ââ 
=
ââ 
data
ââ "
.
ââ" #
County
ââ# )
;
ââ) *
original
ää 
.
ää 
City
ää 
=
ää 
data
ää  
.
ää  !
City
ää! %
;
ää% &
original
ãã 
.
ãã 
StreetAddress
ãã "
=
ãã# $
data
ãã% )
.
ãã) *
StreetAddress
ãã* 7
;
ãã7 8
original
åå 
.
åå 

PostalCode
åå 
=
åå  !
data
åå" &
.
åå& '

PostalCode
åå' 1
;
åå1 2
_context
çç 
.
çç 
Users
çç 
.
çç 
Update
çç !
(
çç! "
original
çç" *
)
çç* +
;
çç+ ,
await
éé 
_context
éé 
.
éé 
SaveChangesAsync
éé +
(
éé+ ,
)
éé, -
;
éé- .
return
èè 
;
èè 
}
êê 	
public
íí 
async
íí 
Task
íí 
ChangePassword
íí (
(
íí( )
ClaimsPrincipal
íí) 8

userClaims
íí9 C
,
ííC D 
UserPasswordChange
ííE W
passwordInfo
ííX d
)
ííd e
{
ìì 	
User
îî 
user
îî 
=
îî 
await
îî 
_userManager
îî *
.
îî* +
GetUserAsync
îî+ 7
(
îî7 8

userClaims
îî8 B
)
îîB C
;
îîC D
var
ïï 
result
ïï 
=
ïï 
await
ïï 
_userManager
ïï +
.
ïï+ ,!
ChangePasswordAsync
ïï, ?
(
ïï? @
user
ïï@ D
,
ïïD E
passwordInfo
ïïF R
.
ïïR S
OldPassword
ïïS ^
,
ïï^ _
passwordInfo
ïï` l
.
ïïl m
NewPassword
ïïm x
)
ïïx y
;
ïïy z
if
ññ 
(
ññ 
!
ññ 
result
ññ 
.
ññ 
	Succeeded
ññ !
)
ññ! "
{
óó 
throw
òò 
new
òò 
	Exception
òò #
(
òò# $
result
òò$ *
.
òò* +
Errors
òò+ 1
.
òò1 2
First
òò2 7
(
òò7 8
)
òò8 9
.
òò9 :
Description
òò: E
)
òòE F
;
òòF G
}
ôô 
}
öö 	
public
úú 
async
úú 
Task
úú 
<
úú 
MailMessage
úú %
>
úú% &-
GenerateEmailAddressChangeEmail
úú' F
(
úúF G
ClaimsPrincipal
úúG V

userClaims
úúW a
,
úúa b
string
úúc i
newEmail
úúj r
)
úúr s
{
ùù 	
User
ûû 
user
ûû 
=
ûû 
await
ûû 
_userManager
ûû *
.
ûû* +
GetUserAsync
ûû+ 7
(
ûû7 8

userClaims
ûû8 B
)
ûûB C
;
ûûC D
EmailChangeToken
üü 
?
üü 
token
üü #
=
üü$ %
await
üü& +
_context
üü, 4
.
üü4 5
EmailChangeTokens
üü5 F
.
üüF G
Where
üüG L
(
üüL M
x
üüM N
=>
üüO Q
x
üüR S
.
üüS T
UserId
üüT Z
==
üü[ ]
user
üü^ b
.
üüb c
Id
üüc e
)
üüe f
.
üüf g!
FirstOrDefaultAsync
üüg z
(
üüz {
)
üü{ |
;
üü| }
if
†† 
(
†† 
token
†† 
!=
†† 
null
†† 
)
†† 
{
°° 
_context
¢¢ 
.
¢¢ 
EmailChangeTokens
¢¢ *
.
¢¢* +
Remove
¢¢+ 1
(
¢¢1 2
token
¢¢2 7
)
¢¢7 8
;
¢¢8 9
}
££ 
_context
§§ 
.
§§ 
EmailChangeTokens
§§ &
.
§§& '
Add
§§' *
(
§§* +
new
§§+ .
EmailChangeToken
§§/ ?
{
§§@ A
UserId
§§B H
=
§§I J
user
§§K O
.
§§O P
Id
§§P R
,
§§R S
Token
§§T Y
=
§§Z [
await
§§\ a
_userManager
§§b n
.
§§n o,
GenerateChangeEmailTokenAsync§§o å
(§§å ç
user§§ç ë
,§§ë í
newEmail§§ì õ
)§§õ ú
,§§ú ù
NewEmail§§û ¶
=§§ß ®
newEmail§§© ±
}§§≤ ≥
)§§≥ ¥
;§§¥ µ
await
•• 
_context
•• 
.
•• 
SaveChangesAsync
•• +
(
••+ ,
)
••, -
;
••- .
token
¶¶ 
=
¶¶ 
await
¶¶ 
_context
¶¶ "
.
¶¶" #
EmailChangeTokens
¶¶# 4
.
¶¶4 5
Where
¶¶5 :
(
¶¶: ;
x
¶¶; <
=>
¶¶= ?
x
¶¶@ A
.
¶¶A B
UserId
¶¶B H
==
¶¶I K
user
¶¶L P
.
¶¶P Q
Id
¶¶Q S
)
¶¶S T
.
¶¶T U

FirstAsync
¶¶U _
(
¶¶_ `
)
¶¶` a
;
¶¶a b
var
®® 
mailMessage
®® 
=
®® 
new
®® !
MailMessage
®®" -
{
©© 
From
™™ 
=
™™ 
new
™™ 
MailAddress
™™ &
(
™™& '
_config
™™' .
.
™™. /
Value
™™/ 4
.
™™4 5
Username
™™5 =
)
™™= >
,
™™> ?
Subject
´´ 
=
´´ 
$str
´´ (
,
´´( )
Body
¨¨ 
=
¨¨ 
$"
¨¨ 
$str
¨¨ I
{
¨¨I J
newEmail
¨¨J R
}
¨¨R S
$str¨¨S Ÿ
{¨¨Ÿ ⁄
token¨¨⁄ ﬂ
.¨¨ﬂ ‡
Token¨¨‡ Â
.¨¨Â Ê
Replace¨¨Ê Ì
(¨¨Ì Ó
$char¨¨Ó Ò
,¨¨Ò Ú
$char¨¨Û ˆ
)¨¨ˆ ˜
}¨¨˜ ¯
$str¨¨¯ ˛
"¨¨˛ ˇ
,¨¨ˇ Ä

IsBodyHtml
≠≠ 
=
≠≠ 
true
≠≠ !
,
≠≠! "
}
ÆÆ 
;
ÆÆ 
mailMessage
ØØ 
.
ØØ 
To
ØØ 
.
ØØ 
Add
ØØ 
(
ØØ 
_config
ØØ &
.
ØØ& '
Value
ØØ' ,
.
ØØ, -
	TestEmail
ØØ- 6
)
ØØ6 7
;
ØØ7 8
return
∞∞ 
mailMessage
∞∞ 
;
∞∞ 
}
±± 	
public
≥≥ 
async
≥≥ 
Task
≥≥ 
<
≥≥ 
List
≥≥ 
<
≥≥ 
string
≥≥ %
>
≥≥% &
>
≥≥& '"
GetUnconfirmedEmails
≥≥( <
(
≥≥< =
ClaimsPrincipal
≥≥= L

userClaims
≥≥M W
)
≥≥W X
{
¥¥ 	
User
µµ 
user
µµ 
=
µµ 
await
µµ 
_userManager
µµ *
.
µµ* +
GetUserAsync
µµ+ 7
(
µµ7 8

userClaims
µµ8 B
)
µµB C
;
µµC D
return
∂∂ 
_context
∂∂ 
.
∂∂ 
EmailChangeTokens
∂∂ -
.
∂∂- .
Where
∂∂. 3
(
∂∂3 4
x
∂∂4 5
=>
∂∂6 8
x
∂∂9 :
.
∂∂: ;
UserId
∂∂; A
==
∂∂B D
user
∂∂E I
.
∂∂I J
Id
∂∂J L
)
∂∂L M
.
∂∂M N
Select
∂∂N T
(
∂∂T U
x
∂∂U V
=>
∂∂W Y
x
∂∂Z [
.
∂∂[ \
NewEmail
∂∂\ d
)
∂∂d e
.
∂∂e f
ToList
∂∂f l
(
∂∂l m
)
∂∂m n
;
∂∂n o
}
∑∑ 	
public
ππ 
async
ππ 
Task
ππ 
ChangeEmail
ππ %
(
ππ% &
string
ππ& ,
token
ππ- 2
)
ππ2 3
{
∫∫ 	
EmailChangeToken
ªª 
?
ªª 
tokenObj
ªª &
=
ªª' (
await
ªª) .
_context
ªª/ 7
.
ªª7 8
EmailChangeTokens
ªª8 I
.
ªªI J
Where
ªªJ O
(
ªªO P
x
ªªP Q
=>
ªªR T
x
ªªU V
.
ªªV W
Token
ªªW \
==
ªª] _
token
ªª` e
)
ªªe f
.
ªªf g!
FirstOrDefaultAsync
ªªg z
(
ªªz {
)
ªª{ |
;
ªª| }
if
ºº 
(
ºº 
tokenObj
ºº 
==
ºº 
null
ºº  
)
ºº  !
{
ΩΩ 
throw
ææ 
new
ææ 
	Exception
ææ #
(
ææ# $
$str
ææ$ <
)
ææ< =
;
ææ= >
}
øø 
User
¿¿ 
user
¿¿ 
=
¿¿ 
await
¿¿ 
_userManager
¿¿ *
.
¿¿* +
FindByIdAsync
¿¿+ 8
(
¿¿8 9
tokenObj
¿¿9 A
.
¿¿A B
UserId
¿¿B H
.
¿¿H I
ToString
¿¿I Q
(
¿¿Q R
)
¿¿R S
)
¿¿S T
;
¿¿T U
var
¡¡ 
result
¡¡ 
=
¡¡ 
await
¡¡ 
_userManager
¡¡ +
.
¡¡+ ,
ChangeEmailAsync
¡¡, <
(
¡¡< =
user
¡¡= A
,
¡¡A B
tokenObj
¡¡C K
.
¡¡K L
NewEmail
¡¡L T
,
¡¡T U
token
¡¡V [
)
¡¡[ \
;
¡¡\ ]
if
¬¬ 
(
¬¬ 
!
¬¬ 
result
¬¬ 
.
¬¬ 
	Succeeded
¬¬ !
)
¬¬! "
{
√√ 
throw
ƒƒ 
new
ƒƒ 
	Exception
ƒƒ #
(
ƒƒ# $
result
ƒƒ$ *
.
ƒƒ* +
Errors
ƒƒ+ 1
.
ƒƒ1 2
First
ƒƒ2 7
(
ƒƒ7 8
)
ƒƒ8 9
.
ƒƒ9 :
Description
ƒƒ: E
)
ƒƒE F
;
ƒƒF G
}
≈≈ 
user
«« 
.
«« 
UserName
«« 
=
«« 
user
««  
.
««  !
Email
««! &
;
««& '
user
»» 
.
»»  
NormalizedUserName
»» #
=
»»$ %
user
»»& *
.
»»* +
NormalizedEmail
»»+ :
;
»»: ;
await
…… 
_userManager
…… 
.
…… 
UpdateAsync
…… *
(
……* +
user
……+ /
)
……/ 0
;
……0 1
_context
ÀÀ 
.
ÀÀ 
EmailChangeTokens
ÀÀ &
.
ÀÀ& '
Remove
ÀÀ' -
(
ÀÀ- .
tokenObj
ÀÀ. 6
)
ÀÀ6 7
;
ÀÀ7 8
await
ÃÃ 
_context
ÃÃ 
.
ÃÃ 
SaveChangesAsync
ÃÃ +
(
ÃÃ+ ,
)
ÃÃ, -
;
ÃÃ- .
}
ÕÕ 	
}
ŒŒ 
}œœ ˘a
e/home/karolis/Github/Univeras/7-semestras/Program≈≥ Sistem≈≥ Testavimas/PST/Backend/MappingProfile.cs
	namespace 	
Backend
 
{ 
public 

class 
MappingProfile 
:  !
Profile" )
{ 
public 
MappingProfile 
( 
) 
:  !
base" &
(& '
$str' /
)/ 0
{ 	
	CreateMap 
< 
User 
, 
UserGet #
># $
($ %

MemberList% /
./ 0
None0 4
)4 5
;5 6
	CreateMap 
< 
RegisterPhysical &
,& '
User( ,
>, -
(- .

MemberList. 8
.8 9
None9 =
)= >
;> ?
	CreateMap 
< 
RegisterLegal #
,# $
User% )
>) *
(* +

MemberList+ 5
.5 6
None6 :
): ;
;; <
	CreateMap 
< 
User 
, 
RegistrationRequest /
>/ 0
(0 1
)1 2
. 
	ForMember 
( 
dest 
=>  "
dest# '
.' (
CompanyName( 3
,3 4
opt5 8
=>9 ;
opt< ?
.? @
MapFrom@ G
(G H
srcH K
=>L N
srcO R
.R S
CompanyNameS ^
)^ _
)_ `
. 
	ForMember 
( 
dest 
=>  "
dest# '
.' (
Email( -
,- .
opt/ 2
=>3 5
opt6 9
.9 :
MapFrom: A
(A B
srcB E
=>F H
srcI L
.L M
EmailM R
)R S
)S T
. 
	ForMember 
( 
dest 
=>  "
dest# '
.' (
CompanyCode( 3
,3 4
opt5 8
=>9 ;
opt< ?
.? @
MapFrom@ G
(G H
srcH K
=>L N
srcO R
.R S
CompanyCodeS ^
)^ _
)_ `
;` a
	CreateMap 
< 
RegistrationRequest )
,) *
RegisterLegal+ 8
>8 9
(9 :

MemberList: D
.D E
NoneE I
)I J
. 
	ForMember 
( 
dest 
=>  "
dest# '
.' (
Username( 0
,0 1
opt2 5
=>6 8
opt9 <
.< =
MapFrom= D
(D E
srcE H
=>I K
srcL O
.O P
EmailP U
)U V
)V W
. 
	ForMember 
( 
dest 
=>  "
dest# '
.' (
CompanyCode( 3
,3 4
opt5 8
=>9 ;
opt< ?
.? @
MapFrom@ G
(G H
srcH K
=>L N
srcO R
.R S
CompanyCodeS ^
)^ _
)_ `
. 
	ForMember 
( 
dest 
=>  "
dest# '
.' (
CompanyName( 3
,3 4
opt5 8
=>9 ;
opt< ?
.? @
MapFrom@ G
(G H
srcH K
=>L N
srcO R
.R S
CompanyNameS ^
)^ _
)_ `
. 
	ForMember 
( 
dest 
=>  "
dest# '
.' (
Email( -
,- .
opt/ 2
=>3 5
opt6 9
.9 :
MapFrom: A
(A B
srcB E
=>F H
srcI L
.L M
EmailM R
)R S
)S T
. 
	ForMember 
( 
dest 
=>  "
dest# '
.' (
Password( 0
,0 1
opt2 5
=>6 8
opt9 <
.< =
MapFrom= D
(D E
srcE H
=>I K
srcL O
.O P
PasswordP X
)X Y
)Y Z
;Z [
	CreateMap!! 
<!! 
Data!! 
.!! 
Models!! !
.!!! "
Console!!" )
,!!) *
ConsoleGetDto!!+ 8
>!!8 9
(!!9 :

MemberList!!: D
.!!D E
None!!E I
)!!I J
."" 
	ForMember"" 
("" 
dest"" 
=>""  "
dest""# '
.""' (
Id""( *
,""* +
opt"", /
=>""0 2
opt""3 6
.""6 7
MapFrom""7 >
(""> ?
src""? B
=>""C E
src""F I
.""I J
Id""J L
)""L M
)""M N
.## 
	ForMember## 
(## 
dest## 
=>##  "
dest### '
.##' (
Name##( ,
,##, -
opt##. 1
=>##2 4
opt##5 8
.##8 9
MapFrom##9 @
(##@ A
src##A D
=>##E G
src##H K
.##K L
Name##L P
)##P Q
)##Q R
.$$ 
	ForMember$$ 
($$ 
dest$$ 
=>$$  "
dest$$# '
.$$' (
Description$$( 3
,$$3 4
opt$$5 8
=>$$9 ;
opt$$< ?
.$$? @
MapFrom$$@ G
($$G H
src$$H K
=>$$L N
src$$O R
.$$R S
Description$$S ^
)$$^ _
)$$_ `
.%% 
	ForMember%% 
(%% 
dest%% 
=>%%  "
dest%%# '
.%%' (

DailyPrice%%( 2
,%%2 3
opt%%4 7
=>%%8 :
opt%%; >
.%%> ?
MapFrom%%? F
(%%F G
src%%G J
=>%%K M
src%%N Q
.%%Q R

DailyPrice%%R \
)%%\ ]
)%%] ^
.&& 
	ForMember&& 
(&& 
dest&& 
=>&&  "
dest&&# '
.&&' (
Images&&( .
,&&. /
opt&&0 3
=>&&4 6
opt&&7 :
.&&: ;
MapFrom&&; B
(&&B C
src&&C F
=>&&G I
src&&J M
.&&M N
Images&&N T
)&&T U
)&&U V
;&&V W
	CreateMap'' 
<'' 
ConsoleAddDto'' #
,''# $
Data''% )
.'') *
Models''* 0
.''0 1
Console''1 8
>''8 9
(''9 :

MemberList'': D
.''D E
None''E I
)''I J
.(( 
	ForMember(( 
((( 
dest(( 
=>((  "
dest((# '
.((' (
Name((( ,
,((, -
opt((. 1
=>((2 4
opt((5 8
.((8 9
MapFrom((9 @
(((@ A
src((A D
=>((E G
src((H K
.((K L
Name((L P
)((P Q
)((Q R
.)) 
	ForMember)) 
()) 
dest)) 
=>))  "
dest))# '
.))' (
Description))( 3
,))3 4
opt))5 8
=>))9 ;
opt))< ?
.))? @
MapFrom))@ G
())G H
src))H K
=>))L N
src))O R
.))R S
Description))S ^
)))^ _
)))_ `
.** 
	ForMember** 
(** 
dest** 
=>**  "
dest**# '
.**' (

DailyPrice**( 2
,**2 3
opt**4 7
=>**8 :
opt**; >
.**> ?
MapFrom**? F
(**F G
src**G J
=>**K M
src**N Q
.**Q R

DailyPrice**R \
)**\ ]
)**] ^
;**^ _
	CreateMap++ 
<++ 
ConsoleUpdateDto++ &
,++& '
Data++( ,
.++, -
Models++- 3
.++3 4
Console++4 ;
>++; <
(++< =

MemberList++= G
.++G H
None++H L
)++L M
.,, 
	ForMember,, 
(,, 
dest,, 
=>,,  "
dest,,# '
.,,' (
Id,,( *
,,,* +
opt,,, /
=>,,0 2
opt,,3 6
.,,6 7
MapFrom,,7 >
(,,> ?
src,,? B
=>,,C E
src,,F I
.,,I J
Id,,J L
),,L M
),,M N
.-- 
	ForMember-- 
(-- 
dest-- 
=>--  "
dest--# '
.--' (
Name--( ,
,--, -
opt--. 1
=>--2 4
opt--5 8
.--8 9
MapFrom--9 @
(--@ A
src--A D
=>--E G
src--H K
.--K L
Name--L P
)--P Q
)--Q R
... 
	ForMember.. 
(.. 
dest.. 
=>..  "
dest..# '
...' (
Description..( 3
,..3 4
opt..5 8
=>..9 ;
opt..< ?
...? @
MapFrom..@ G
(..G H
src..H K
=>..L N
src..O R
...R S
Description..S ^
)..^ _
).._ `
.// 
	ForMember// 
(// 
dest// 
=>//  "
dest//# '
.//' (

DailyPrice//( 2
,//2 3
opt//4 7
=>//8 :
opt//; >
.//> ?
MapFrom//? F
(//F G
src//G J
=>//K M
src//N Q
.//Q R

DailyPrice//R \
)//\ ]
)//] ^
;//^ _
	CreateMap11 
<11 
Image11 
,11 
ImageGetDto11 (
>11( )
(11) *

MemberList11* 4
.114 5
None115 9
)119 :
;11: ;
	CreateMap22 
<22 
ImageAddDto22 !
,22! "
Image22# (
>22( )
(22) *

MemberList22* 4
.224 5
None225 9
)229 :
;22: ;
	CreateMap33 
<33 
ImageUpdateDto33 $
,33$ %
Image33& +
>33+ ,
(33, -

MemberList33- 7
.337 8
None338 <
)33< =
;33= >
	CreateMap44 
<44 
Image44 
,44 
ImageAddDto44 (
>44( )
(44) *

MemberList44* 4
.444 5
None445 9
)449 :
;44: ;
	CreateMap66 
<66 
MessageFile66 !
,66! "
MessageFileGetDto66# 4
>664 5
(665 6

MemberList666 @
.66@ A
None66A E
)66E F
;66F G
	CreateMap77 
<77 
MessageFileAddDto77 '
,77' (
MessageFile77) 4
>774 5
(775 6

MemberList776 @
.77@ A
None77A E
)77E F
;77F G
	CreateMap99 
<99 
UserConsole99 !
,99! "
UserConsoleGetDto99# 4
>994 5
(995 6

MemberList996 @
.99@ A
None99A E
)99E F
;99F G
	CreateMap:: 
<:: 
UserConsoleAddDto:: '
,::' (
UserConsole::) 4
>::4 5
(::5 6

MemberList::6 @
.::@ A
None::A E
)::E F
;::F G
	CreateMap;; 
<;;  
UserConsoleUpdateDto;; *
,;;* +
UserConsole;;, 7
>;;7 8
(;;8 9

MemberList;;9 C
.;;C D
None;;D H
);;H I
;;;I J
	CreateMap== 
<== 
Conversation== "
,==" #
ConversationGetDto==$ 6
>==6 7
(==7 8

MemberList==8 B
.==B C
None==C G
)==G H
;==H I
	CreateMap>> 
<>> 
Message>> 
,>> 
MessageGetDto>> ,
>>>, -
(>>- .

MemberList>>. 8
.>>8 9
None>>9 =
)>>= >
;>>> ?
	CreateMap@@ 
<@@ 
	Borrowing@@ 
,@@  
BorrowingGetDto@@! 0
>@@0 1
(@@1 2

MemberList@@2 <
.@@< =
None@@= A
)@@A B
;@@B C
}BB 	
}CC 
}DD ºC
^/home/karolis/Github/Univeras/7-semestras/Program≈≥ Sistem≈≥ Testavimas/PST/Backend/Program.cs
var

 
builder

 
=

 
WebApplication

 
.

 
CreateBuilder

 *
(

* +
args

+ /
)

/ 0
;

0 1
{ 
var 
services 
= 
builder 
. 
Services #
;# $
services 
. 
AddControllers 
( 
) 
; 
services 
. 
AddCors 
( 
options 
=> 
{ 
options 
. 
AddDefaultPolicy  
(  !
policy! '
=>( *
{ 	
policy 
. 
WithOrigins 
( 
$str 6
)6 7
. 
AllowAnyHeader !
(! "
)" #
. 
AllowAnyMethod !
(! "
)" #
. 
AllowCredentials #
(# $
)$ %
;% &
} 	
)	 

;
 
} 
) 
; 
services 
. #
AddEndpointsApiExplorer $
($ %
)% &
;& '
services 
. 
AddSwaggerGen 
( 
) 
; 
services   
.   
AddAuthentication   
(   
options   &
=>  ' )
{!! 
options"" 
."" 
DefaultScheme"" 
="" (
CookieAuthenticationDefaults""  <
.""< = 
AuthenticationScheme""= Q
;""Q R
}## 
)## 
;## 
services$$ 
.$$ 
AddIdentity$$ 
<$$ 
User$$ 
,$$ 
IdentityRole$$ +
<$$+ ,
int$$, /
>$$/ 0
>$$0 1
($$1 2
)$$2 3
.%% 	$
AddEntityFrameworkStores%%	 !
<%%! "
AppDbContext%%" .
>%%. /
(%%/ 0
)%%0 1
.&& 	
AddTokenProvider&&	 
<&& &
DataProtectorTokenProvider&& 4
<&&4 5
User&&5 9
>&&9 :
>&&: ;
(&&; <
TokenOptions&&< H
.&&H I
DefaultProvider&&I X
)&&X Y
;&&Y Z
services'' 
.'' 
	Configure'' 
<'' 
IdentityOptions'' &
>''& '
(''' (
options''( /
=>''0 2
{(( 
options)) 
.)) 
Password)) 
.)) 
RequireDigit)) %
=))& '
true))( ,
;)), -
options** 
.** 
Password** 
.** 
RequireLowercase** )
=*** +
true**, 0
;**0 1
options++ 
.++ 
Password++ 
.++ "
RequireNonAlphanumeric++ /
=++0 1
true++2 6
;++6 7
options,, 
.,, 
Password,, 
.,, 
RequireUppercase,, )
=,,* +
true,,, 0
;,,0 1
options-- 
.-- 
Password-- 
.-- 
RequiredLength-- '
=--( )
$num--* +
;--+ ,
options// 
.// 
User// 
.// %
AllowedUserNameCharacters// .
=/// 0
$str00 S
;00S T
options11 
.11 
User11 
.11 
RequireUniqueEmail11 '
=11( )
true11* .
;11. /
}22 
)22 
;22 
builder44 
.44 
Services44 
.44 &
ConfigureApplicationCookie44 /
(44/ 0
options440 7
=>448 :
{55 
options66 
.66 
Cookie66 
.66 
SameSite66 
=66  !
SameSiteMode66" .
.66. /
None66/ 3
;663 4
}77 
)77 
;77 
string:: 

connectionString:: 
=:: 
builder:: %
.::% &
Configuration::& 3
.::3 4
GetConnectionString::4 G
(::G H
$str::H [
)::[ \
;::\ ]
services;; 
.;; 
AddDbContext;; 
<;; 
AppDbContext;; &
>;;& '
(;;' (
options;;( /
=>;;0 2
options<< 
.<< 
UseMySql<< 
(<< 
connectionString<< )
,<<) *
ServerVersion<<+ 8
.<<8 9

AutoDetect<<9 C
(<<C D
connectionString<<D T
)<<T U
)<<U V
)<<V W
;<<W X
services?? 
.?? 
	Configure?? 
<?? 
CloudinaryConfig?? '
>??' (
(??( )
builder??) 0
.??0 1
Configuration??1 >
.??> ?

GetSection??? I
(??I J
$str??J X
)??X Y
)??Y Z
;??Z [
services@@ 
.@@ 
	Configure@@ 
<@@ 

SmtpConfig@@ !
>@@! "
(@@" #
builder@@# *
.@@* +
Configuration@@+ 8
.@@8 9

GetSection@@9 C
(@@C D
$str@@D J
)@@J K
)@@K L
;@@L M
servicesCC 
.CC 
AddTransientCC 
<CC 
UserManagerCC %
<CC% &
UserCC& *
>CC* +
>CC+ ,
(CC, -
)CC- .
;CC. /
servicesDD 
.DD 
AddTransientDD 
<DD 
RoleManagerDD %
<DD% &
IdentityRoleDD& 2
<DD2 3
intDD3 6
>DD6 7
>DD7 8
>DD8 9
(DD9 :
)DD: ;
;DD; <
servicesEE 
.EE 
AddTransientEE 
<EE 
AuthHandlerEE %
>EE% &
(EE& '
)EE' (
;EE( )
servicesFF 
.FF 
AddTransientFF 
<FF 
ConsolesHandlerFF )
>FF) *
(FF* +
)FF+ ,
;FF, -
servicesGG 
.GG 
AddTransientGG 
<GG 
UsersHandlerGG &
>GG& '
(GG' (
)GG( )
;GG) *
servicesHH 
.HH 
AddTransientHH 
<HH 
FilesHandlerHH &
>HH& '
(HH' (
)HH( )
;HH) *
servicesII 
.II 
AddTransientII 
<II 
UserConsolesHandlerII -
>II- .
(II. /
)II/ 0
;II0 1
servicesJJ 
.JJ 
AddTransientJJ 
<JJ 
BorrowingsHandlerJJ +
>JJ+ ,
(JJ, -
)JJ- .
;JJ. /
servicesKK 
.KK 
AddTransientKK 
<KK 
ChatsHandlerKK &
>KK& '
(KK' (
)KK( )
;KK) *
servicesLL 
.LL 
AddAutoMapperLL 
(LL 
	AppDomainLL $
.LL$ %
CurrentDomainLL% 2
.LL2 3
GetAssembliesLL3 @
(LL@ A
)LLA B
)LLB C
;LLC D
}MM 
varOO 
appOO 
=OO 	
builderOO
 
.OO 
BuildOO 
(OO 
)OO 
;OO 
ifRR 
(RR 
appRR 
.RR 
EnvironmentRR 
.RR 
IsDevelopmentRR !
(RR! "
)RR" #
)RR# $
{SS 
appTT 
.TT 

UseSwaggerTT 
(TT 
)TT 
;TT 
appUU 
.UU 
UseSwaggerUIUU 
(UU 
)UU 
;UU 
}VV 
appXX 
.XX 
UseHttpsRedirectionXX 
(XX 
)XX 
;XX 
appZZ 
.ZZ 
UseCorsZZ 
(ZZ 
)ZZ 
;ZZ 
app\\ 
.\\ 

UseRouting\\ 
(\\ 
)\\ 
;\\ 
app^^ 
.^^ 
UseAuthentication^^ 
(^^ 
)^^ 
;^^ 
app__ 
.__ 
UseAuthorization__ 
(__ 
)__ 
;__ 
appaa 
.aa 
MapControllersaa 
(aa 
)aa 
;aa 
appcc 
.cc 
Runcc 
(cc 
)cc 	
;cc	 
í
r/home/karolis/Github/Univeras/7-semestras/Program≈≥ Sistem≈≥ Testavimas/PST/Backend/Properties/CloudinaryConfig.cs
	namespace 	
Backend
 
. 

Properties 
{ 
public 

class 
CloudinaryConfig !
{ 
public 
string 
Cloud 
{ 
get !
;! "
set# &
;& '
}( )
public 
string 
ApiKey 
{ 
get "
;" #
set$ '
;' (
}) *
public 
string 
	ApiSecret 
{  !
get" %
;% &
set' *
;* +
}, -
} 
}		 ã
l/home/karolis/Github/Univeras/7-semestras/Program≈≥ Sistem≈≥ Testavimas/PST/Backend/Properties/SmtpConfig.cs
	namespace 	
Backend
 
. 

Properties 
{ 
public 

class 

SmtpConfig 
{ 
public 
string 
Username 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
string 
Password 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
string 
	TestEmail 
{  !
get" %
;% &
set' *
;* +
}, -
} 
}		 Ö	
k/home/karolis/Github/Univeras/7-semestras/Program≈≥ Sistem≈≥ Testavimas/PST/Backend/Services/MailService.cs
	namespace 	
Backend
 
. 
Services 
{		 
public

 

static

 
class

 
MailService

 #
{ 
public 
static 
void 
	SendEmail $
($ %
MailMessage% 0
mailMessage1 <
)< =
{ 	
var 

smtpClient 
= 
new  

SmtpClient! +
(+ ,
$str, <
)< =
{ 
Port 
= 
$num 
, 
Credentials 
= 
new !
NetworkCredential" 3
(3 4
$str4 N
,N O
$strP b
)b c
,c d
	EnableSsl 
= 
true  
,  !
} 
; 

smtpClient 
. 
Send 
( 
mailMessage '
)' (
;( )
} 	
} 
} 